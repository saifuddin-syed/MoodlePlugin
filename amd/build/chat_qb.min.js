define("local_automation/chat_qb",["jquery"],(function($){let selectedCourseId=null,questionType=null,counts={ia2marks:0,ia5marks:0,ese5marks:0,ese10marks:0},fileMetaById={},selectedFileIds=[],editMode=!1,lastResult=null;function escapeHtml(str){return null==str?"":String(str).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}function applyQbInlineStyles(){const $panel=$("#qb-panel");$panel.length&&($panel.css({zIndex:10,background:"#ffffff",padding:"8px 10px 10px 10px",borderBottom:"1px solid #e0e0e0",boxShadow:"0 2px 4px rgba(0,0,0,0.04)"}),$(".qb-row",$panel).css({marginBottom:"6px",display:"flex",flexWrap:"wrap",alignItems:"center",gap:"6px"}),$("#qb-panel label").css({fontSize:"0.8rem"}),$("#qb-course-select, #qb-ia-2, #qb-ia-5, #qb-ese-5, #qb-ese-10").css({padding:"4px 8px",borderRadius:"6px",border:"1px solid #d0d0d0",background:"#fafafa",fontSize:"0.8rem"}),$(".qb-qtype-group",$panel).css({display:"flex",gap:"12px",fontSize:"0.8rem"}),$(".qb-qtype-group label",$panel).css({display:"flex",alignItems:"center",gap:"6px",padding:"4px 8px",borderRadius:"999px",border:"1px solid #e0e0e0",cursor:"pointer",background:"#ffffff"}),$('.qb-qtype-group input[type="radio"]',$panel).css({accentColor:"#1976d2"}),$("#qb-files-tree").css({width:"100%",maxHeight:"220px",overflow:"auto",padding:"6px 8px",borderRadius:"8px",border:"1px solid #e0e0e0",background:"#fafafa",fontSize:"0.8rem"}),$(".qb-section-title").css({fontWeight:600,marginBottom:"3px",display:"flex",alignItems:"center",gap:"6px",color:"#37474f"}),$(".qb-folder").css({marginLeft:"8px"}),$(".qb-folder > summary").css({listStyle:"none",cursor:"pointer",padding:"3px 6px",borderRadius:"4px",display:"flex",alignItems:"center",gap:"6px"}),$(".qb-tree-level").css({marginLeft:"14px",paddingLeft:"4px",borderLeft:"1px dashed #d0d0d0"}),$(".qb-file label").css({display:"flex",alignItems:"center",gap:"6px",padding:"2px 6px",borderRadius:"4px",cursor:"pointer"}),$('.qb-file input[type="checkbox"]').css({accentColor:"#1976d2"}),$(".qb-hint").css({flexDirection:"column",alignItems:"flex-start",padding:"6px 8px",borderRadius:"6px",background:"#f5f5f5"}),$(".qb-hint-title").css({fontWeight:600,fontSize:"0.8rem",marginBottom:"2px"}),$(".qb-hint-sub").css({fontSize:"0.75rem",color:"#555"}))}function ensurePanel(){if($("#qb-panel").length)return;$("#chatbot-messages").prepend('\n            <div id="qb-panel" class="qb-panel">\n                <div class="qb-row">\n                    <label>Subject (course)</label>\n                    <select id="qb-course-select">\n                        <option value="">Select course...</option>\n                        \x3c!-- Options will be loaded via AJAX --\x3e\n                    </select>\n                </div>\n\n                <div class="qb-row" id="qb-topics-container">\n                    <div class="qb-row">\n                        <label>\n                            <input type="checkbox" id="qb-use-all-resources">\n                            Select all supported files (PDF / PPT / Word)\n                        </label>\n                    </div>\n                    <div id="qb-files-tree" class="qb-files-tree">\n                        \x3c!-- Sections + folders + files will be rendered here --\x3e\n                    </div>\n                </div>\n\n                <div class="qb-row">\n                    <label>Question type</label>\n                    <div class="qb-qtype-group">\n                        <label>\n                            <input type="radio" name="qb-qtype" value="IA">\n                            <span>IA Type (2 marks &amp; 5 marks)</span>\n                        </label>\n                        <label>\n                            <input type="radio" name="qb-qtype" value="ESE">\n                            <span>ESE Type (5 marks &amp; 10 marks)</span>\n                        </label>\n                    </div>\n                </div>\n\n                <div id="qb-counts-ia" class="qb-counts" style="display:none;">\n                    <div class="qb-row">\n                        <label>\n                            No. of 2 marks questions:\n                            <input type="number" id="qb-ia-2" min="0" max="50" value="0">\n                        </label>\n                    </div>\n                    <div class="qb-row">\n                        <label>\n                            No. of 5 marks questions:\n                            <input type="number" id="qb-ia-5" min="0" max="50" value="0">\n                        </label>\n                    </div>\n                </div>\n\n                <div id="qb-counts-ese" class="qb-counts" style="display:none;">\n                    <div class="qb-row">\n                        <label>\n                            No. of 5 marks questions:\n                            <input type="number" id="qb-ese-5" min="0" max="50" value="0">\n                        </label>\n                    </div>\n                    <div class="qb-row">\n                        <label>\n                            No. of 10 marks questions:\n                            <input type="number" id="qb-ese-10" min="0" max="50" value="0">\n                        </label>\n                    </div>\n                </div>\n\n                <div class="qb-row qb-hint">\n                    <div class="qb-hint-title">Type Preferences (optional)</div>\n                    <div class="qb-hint-sub">\n                        Use the box below for extra preferences, e.g.\n                        ‚Äúfocus on trees‚Äù, ‚Äúmix all topics‚Äù, ‚Äúavoid proofs‚Äù.\n                        Leave it empty for a general question bank.\n                    </div>\n                </div>\n            </div>\n        '),$("#qb-controls-fab").length||$("#chatbot-messages").append('\n                <button id="qb-controls-fab" title="Back to controls">\n                    ‚ñ≤ Controls\n                </button>\n            '),applyQbInlineStyles(),function(){const $messages=$("#chatbot-messages");$messages.on("scroll.qb",(function(){const $fab=$("#qb-controls-fab");$fab.length&&(this.scrollTop>150?$fab.fadeIn(150):$fab.fadeOut(150))})),$messages.on("click.qb","#qb-controls-fab",(function(){$messages.animate({scrollTop:0},200)})),$("#qb-course-select").on("change",(function(){const cid=$(this).val();selectedCourseId=cid?parseInt(cid,10):null,function(courseid){if(!courseid)return $("#qb-files-tree").empty(),fileMetaById={},selectedFileIds=[],$("#qb-use-all-resources").prop("checked",!1),void updateGenerateState();$.ajax({url:M.cfg.wwwroot+"/local/automation/qb_ajax.php",method:"POST",data:JSON.stringify({action:"fetch_files",courseid:courseid,sesskey:M.cfg.sesskey}),contentType:"application/json",dataType:"json",success:function(res){if(!res||!res.success)return console.error("QB fetch_files error:",res),$("#qb-files-tree").html('<div class="qb-info">No files found for this course.</div>'),fileMetaById={},selectedFileIds=[],void updateGenerateState();!function(sections){if(fileMetaById={},selectedFileIds=[],$("#qb-use-all-resources").prop("checked",!1),!sections.length)return $("#qb-files-tree").html('<div class="qb-info">No supported files (PDF/PPT/Word) found in this course.</div>'),void updateGenerateState();let html="";sections.forEach((section=>{const sname=escapeHtml(section.name||"Topic"),files=Array.isArray(section.files)?section.files:[];if(!files.length)return;const treeRoot=function(section,files){const root={type:"root",name:section.name||"Section",children:{}};return files.forEach((file=>{const fileid=file.fileid,name=file.name,path=file.path||name;fileMetaById[fileid]={name:name,path:path,sectionname:section.name||"",courseid:section.courseid||selectedCourseId};const parts=path.split("/").filter(Boolean);let node=root;for(let i=0;i<parts.length-1;i++){const folderName=parts[i];node.children[folderName]||(node.children[folderName]={type:"folder",name:folderName,children:{}}),node=node.children[folderName]}const filename=parts[parts.length-1]||name,key=filename+"__"+fileid;node.children[key]={type:"file",name:filename,fileid:fileid}})),root}(section,files);html+='\n                <div class="qb-section">\n                    <div class="qb-section-title">\n                        <span class="qb-icon qb-icon-section">üìö</span>\n                        '.concat(sname,'\n                    </div>\n                    <div class="qb-section-tree">\n                        ').concat(renderTreeNode(treeRoot),"\n                    </div>\n                </div>\n            ")})),html||(html='<div class="qb-info">No supported files (PDF/PPT/Word) found in this course.</div>');$("#qb-files-tree").html(html),applyQbInlineStyles(),updateGenerateState()}(res.sections||[])},error:function(xhr){console.error("QB fetch_files AJAX error:",xhr),$("#qb-files-tree").html('<div class="qb-info">Failed to load files.</div>'),fileMetaById={},selectedFileIds=[],updateGenerateState()}})}(selectedCourseId),updateGenerateState()})),$("#qb-use-all-resources").on("change",(function(){const checked=$(this).is(":checked");$(".qb-file-checkbox").prop("checked",checked),recomputeSelectedFiles(),updateGenerateState()})),$('input[name="qb-qtype"]').on("change",(function(){const val=$(this).val();"IA"===val?($("#qb-counts-ia").show(),$("#qb-counts-ese").hide()):"ESE"===val?($("#qb-counts-ia").hide(),$("#qb-counts-ese").show()):($("#qb-counts-ia").hide(),$("#qb-counts-ese").hide()),updateGenerateState()})),$("#qb-ia-2, #qb-ia-5, #qb-ese-5, #qb-ese-10").on("input",(function(){updateGenerateState()})),$("#chatbot-messages").on("change",".qb-file-checkbox",(function(){recomputeSelectedFiles();const totalFiles=$(".qb-file-checkbox").length,totalSelected=$(".qb-file-checkbox:checked").length;$("#qb-use-all-resources").prop("checked",totalFiles>0&&totalFiles===totalSelected),updateGenerateState()})),$("#chatbot-messages").on("click",".qb-download-btn",(function(){const url=$(this).data("downloadUrl");url&&window.open(url,"_blank")})).on("click",".qb-upload-btn",(function(){const $btn=$(this),fileid=$btn.data("fileid"),courseid=$btn.data("courseid"),qtype=$btn.data("questiontype")||questionType||"IA";fileid&&courseid&&!$btn.prop("disabled")&&($btn.prop("disabled",!0).text("Uploading..."),$.ajax({url:M.cfg.wwwroot+"/local/automation/qb_ajax.php",method:"POST",data:JSON.stringify({action:"upload_qb",fileid:fileid,courseid:courseid,questiontype:qtype,sesskey:M.cfg.sesskey}),contentType:"application/json",dataType:"json",success:function(res){res&&res.success?$btn.text("Uploaded"):($btn.prop("disabled",!1).text("Upload failed"),console.error("QB upload error:",res))},error:function(xhr){$btn.prop("disabled",!1).text("Upload failed"),console.error("QB upload AJAX error:",xhr),alert("Upload failed. See server logs.")}}))}))}(),updateGenerateState(),$.ajax({url:M.cfg.wwwroot+"/local/automation/qb_ajax.php",method:"POST",data:JSON.stringify({action:"fetch_courses",sesskey:M.cfg.sesskey}),contentType:"application/json",dataType:"json",success:function(res){res&&res.success?function(courses){const $select=$("#qb-course-select");$select.empty(),$select.append('<option value="">Select course...</option>'),courses.forEach((c=>{const label=escapeHtml(c.fullname||c.shortname||"Course "+c.id);$select.append('<option value="'.concat(String(c.id),'">').concat(label,"</option>"))}))}(res.courses||[]):console.error("QB fetch_courses error:",res)},error:function(xhr){console.error("QB fetch_courses AJAX error:",xhr)}})}function renderTreeNode(node){if(!node||!node.children)return"";const keys=Object.keys(node.children);if(!keys.length)return"";let html='<div class="qb-tree-level">';return keys.forEach((key=>{const child=node.children[key];if("folder"===child.type)html+='\n                    <details class="qb-folder">\n                        <summary>\n                            <span class="qb-icon qb-icon-folder">üìÅ</span>\n                            '.concat(escapeHtml(child.name),"\n                        </summary>\n                        ").concat(renderTreeNode(child),"\n                    </details>\n                ");else if("file"===child.type){const fid=String(child.fileid),fname=escapeHtml(child.name);html+='\n                    <div class="qb-file">\n                        <label>\n                            <input type="checkbox" class="qb-file-checkbox" data-fileid="'.concat(fid,'">\n                            <span class="qb-icon qb-icon-file">üìÑ</span>\n                            ').concat(fname,"\n                        </label>\n                    </div>\n                ")}})),html+="</div>",html}function recomputeSelectedFiles(){selectedFileIds=[],$(".qb-file-checkbox:checked").each((function(){const fid=$(this).data("fileid");null!=fid&&selectedFileIds.push(String(fid))}))}function updateGenerateState(){const courseidVal=$("#qb-course-select").val();selectedCourseId=courseidVal?parseInt(courseidVal,10):null,counts.ia2marks=parseInt($("#qb-ia-2").val()||"0",10),counts.ia5marks=parseInt($("#qb-ia-5").val()||"0",10),counts.ese5marks=parseInt($("#qb-ese-5").val()||"0",10),counts.ese10marks=parseInt($("#qb-ese-10").val()||"0",10);const qtype=$('input[name="qb-qtype"]:checked').val();questionType=qtype||null;let enabled=!1;const hasCourse=!!selectedCourseId,hasFiles=selectedFileIds.length>0;let hasCounts=!1;"IA"===questionType?(0===counts.ia2marks&&0===counts.ia5marks&&(counts.ia2marks=5,counts.ia5marks=5,$("#qb-ia-2").val(5),$("#qb-ia-5").val(5)),hasCounts=counts.ia2marks>0||counts.ia5marks>0):"ESE"===questionType&&(0===counts.ese5marks&&0===counts.ese10marks&&(counts.ese5marks=5,counts.ese10marks=5,$("#qb-ese-5").val(5),$("#qb-ese-10").val(5)),hasCounts=counts.ese5marks>0||counts.ese10marks>0),enabled=hasCourse&&hasFiles&&!!questionType&&hasCounts,$("#chatbot-input").prop("disabled",!enabled),$("#chatbot-send-btn").prop("disabled",!enabled)}return{beforeSend:function(text){return text},handleResponse:function(res,ui){return!1},reset:function(){selectedCourseId=null,questionType=null,counts={ia2marks:0,ia5marks:0,ese5marks:0,ese10marks:0},fileMetaById={},selectedFileIds=[],editMode=!1,lastResult=null,$("#qb-panel").remove(),$("#qb-controls-fab").remove(),$("#chatbot-messages").off(".qb"),$("#chatbot-input").prop("disabled",!1),$("#chatbot-send-btn").prop("disabled",!1).text("Send")},onModeActivated:function(){ensurePanel(),$("#chatbot-send-btn").text("Generate"),editMode=!1,updateGenerateState()},generate:function(instructions,ui){if(updateGenerateState(),!selectedCourseId)return void ui.appendMessage("‚ö†Ô∏è Please select a course first.","bot");if(!questionType)return void ui.appendMessage("‚ö†Ô∏è Please choose question type (IA / ESE).","bot");if(!selectedFileIds.length)return void ui.appendMessage("‚ö†Ô∏è Please select at least one file.","bot");let hasCounts=!1;if("IA"===questionType?hasCounts=counts.ia2marks>0||counts.ia5marks>0:"ESE"===questionType&&(hasCounts=counts.ese5marks>0||counts.ese10marks>0),!hasCounts)return void ui.appendMessage("‚ö†Ô∏è Please set at least one question count.","bot");$("#qb-course-select").prop("disabled",!0),$("#qb-use-all-resources").prop("disabled",!0),$('input[name="qb-qtype"]').prop("disabled",!0),$("#qb-ia-2, #qb-ia-5, #qb-ese-5, #qb-ese-10").prop("disabled",!0),$("#chatbot-input").prop("disabled",!0),$("#chatbot-send-btn").prop("disabled",!0);const trimmed=(instructions||"").trim();editMode&&lastResult&&trimmed.length>0?ui.appendMessage("‚úèÔ∏è Updating question bank...","bot"):editMode?ui.appendMessage("‚è≥ Regenerating Question Bank...","bot"):ui.appendMessage("‚è≥ Creating Question Bank...","bot");const payload={courseid:selectedCourseId,selectedfiles:selectedFileIds,filemeta:fileMetaById,questiontype:questionType,counts:counts,instructions:instructions||"",sesskey:M.cfg.sesskey};editMode&&lastResult?(payload.mode="edit",payload.previous=lastResult):payload.mode="initial",$.ajax({url:M.cfg.wwwroot+"/local/automation/qb_ajax.php",method:"POST",data:JSON.stringify(payload),contentType:"application/json",dataType:"json",success:function(res){if(console.log("QB AJAX response:",res),res&&res.success){const downloadurl=res.downloadurl||"#",fileid=res.fileid||0,courseid=res.courseid||selectedCourseId;lastResult=res.data||res.questions||null,editMode=!0;const html='\n                        <div class="automation-box">\n                            <b>QB Generation Completed ‚úÖ</b><br>\n                            '.concat(res.message?escapeHtml(res.message)+"<br>":"",'\n                            <button class="qb-download-btn" data-download-url="').concat(escapeHtml(downloadurl),'">\n                                Download PDF\n                            </button>\n                            <button class="qb-upload-btn"\n                                    data-fileid="').concat(escapeHtml(String(fileid)),'"\n                                    data-courseid="').concat(escapeHtml(String(courseid)),'"\n                                    data-questiontype="').concat(escapeHtml(String(questionType||"IA")),'">\n                                Upload to course\n                            </button>\n                            <div class="qb-edit-hint">\n                                Type any edits or modifications in the box below and click\n                                <b>Generate</b> again to update this Question Bank.\n                            </div>\n                        </div>\n                    ');ui.appendMessage(html,"bot")}else ui.appendMessage("‚ùå Error: "+escapeHtml(res&&res.error?res.error:"Unknown error"),"bot");$("#qb-course-select").prop("disabled",!1),$("#qb-use-all-resources").prop("disabled",!1),$('input[name="qb-qtype"]').prop("disabled",!1),$("#qb-ia-2, #qb-ia-5, #qb-ese-5, #qb-ese-10").prop("disabled",!1),$("#chatbot-input").prop("disabled",!1),$("#chatbot-send-btn").prop("disabled",!1)},error:function(xhr){console.error("QB AJAX error:",xhr);let msg="Failed to generate question bank. See server logs.";xhr.responseJSON&&xhr.responseJSON.error&&(msg=xhr.responseJSON.error),ui.appendMessage("‚ùå "+msg,"bot"),$("#qb-course-select").prop("disabled",!1),$("#qb-use-all-resources").prop("disabled",!1),$('input[name="qb-qtype"]').prop("disabled",!1),$("#qb-ia-2, #qb-ia-5, #qb-ese-5, #qb-ese-10").prop("disabled",!1),$("#chatbot-input").prop("disabled",!1),$("#chatbot-send-btn").prop("disabled",!1)}})}}}));

//# sourceMappingURL=chat_qb.min.js.map