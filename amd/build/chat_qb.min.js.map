{"version":3,"file":"chat_qb.min.js","sources":["../src/chat_qb.js"],"sourcesContent":["// local/automation/amd/src/chat_qb.js\r\ndefine(['jquery'], function($) {\r\n    'use strict';\r\n\r\n    // --- State ---\r\n\r\n    let selectedCourseId = null;\r\n    let questionType = null; // 'IA' or 'ESE'\r\n\r\n    let counts = {\r\n        ia2marks: 0,\r\n        ia5marks: 0,\r\n        ese5marks: 0,\r\n        ese10marks: 0\r\n    };\r\n\r\n    // File selection\r\n    let fileMetaById = {};      // fileid -> { name, path, sectionname, courseid }\r\n    let selectedFileIds = [];   // array of selected fileids\r\n\r\n    // Edit flow state\r\n    let editMode = false;       // true after first successful generation\r\n    let lastResult = null;      // whatever qb_ajax returns to represent last QB\r\n\r\n    // --- Helpers shared with chatbot.js ---\r\n\r\n    function reset() {\r\n        selectedCourseId = null;\r\n        questionType = null;\r\n\r\n        counts = {\r\n            ia2marks: 0,\r\n            ia5marks: 0,\r\n            ese5marks: 0,\r\n            ese10marks: 0\r\n        };\r\n\r\n        fileMetaById = {};\r\n        selectedFileIds = [];\r\n        editMode = false;\r\n        lastResult = null;\r\n\r\n        $('#qb-panel').remove();\r\n        $('#chatbot-input').prop('disabled', false);\r\n        $('#chatbot-send-btn').prop('disabled', false).text('Send');\r\n    }\r\n\r\n    function beforeSend(text) {\r\n        // Not used for QB; chatbot.js calls generate() directly.\r\n        return text;\r\n    }\r\n\r\n    function handleResponse(res, ui) {\r\n        // QB does not consume chatbot_endpoint.php responses.\r\n        return false;\r\n    }\r\n\r\n    // Escape HTML helper to avoid XSS\r\n    function escapeHtml(str) {\r\n        if (str === null || str === undefined) return '';\r\n        return String(str)\r\n            .replace(/&/g, '&amp;')\r\n            .replace(/</g, '&lt;')\r\n            .replace(/>/g, '&gt;')\r\n            .replace(/\"/g, '&quot;')\r\n            .replace(/'/g, '&#039;');\r\n    }\r\n\r\n    // --- UI PANEL CREATION ---\r\n\r\n    function ensurePanel() {\r\n        if ($('#qb-panel').length) {\r\n            return;\r\n        }\r\n\r\n        const html = `\r\n            <div id=\"qb-panel\" class=\"qb-panel\">\r\n                <div class=\"qb-row\">\r\n                    <label>Subject (course)</label>\r\n                    <select id=\"qb-course-select\">\r\n                        <option value=\"\">Select course...</option>\r\n                        <!-- Options will be loaded via AJAX -->\r\n                    </select>\r\n                </div>\r\n\r\n                <div class=\"qb-row\" id=\"qb-topics-container\">\r\n                    <div class=\"qb-row\">\r\n                        <label>\r\n                            <input type=\"checkbox\" id=\"qb-use-all-resources\">\r\n                            Select all supported files (PDF / PPT / Word)\r\n                        </label>\r\n                    </div>\r\n                    <div id=\"qb-files-tree\" class=\"qb-files-tree\">\r\n                        <!-- Sections + folders + files will be rendered here -->\r\n                    </div>\r\n                </div>\r\n\r\n                <div class=\"qb-row\">\r\n                    <label>Question type</label>\r\n                    <div class=\"qb-qtype-group\">\r\n                        <label>\r\n                            <input type=\"radio\" name=\"qb-qtype\" value=\"IA\">\r\n                            IA Type (2 marks &amp; 5 marks)\r\n                        </label>\r\n                        <label>\r\n                            <input type=\"radio\" name=\"qb-qtype\" value=\"ESE\">\r\n                            ESE Type (5 marks &amp; 10 marks)\r\n                        </label>\r\n                    </div>\r\n                </div>\r\n\r\n                <div id=\"qb-counts-ia\" class=\"qb-counts\" style=\"display:none;\">\r\n                    <div class=\"qb-row\">\r\n                        <label>\r\n                            No. of 2 marks questions:\r\n                            <input type=\"number\" id=\"qb-ia-2\" min=\"0\" max=\"50\" value=\"0\">\r\n                        </label>\r\n                    </div>\r\n                    <div class=\"qb-row\">\r\n                        <label>\r\n                            No. of 5 marks questions:\r\n                            <input type=\"number\" id=\"qb-ia-5\" min=\"0\" max=\"50\" value=\"0\">\r\n                        </label>\r\n                    </div>\r\n                </div>\r\n\r\n                <div id=\"qb-counts-ese\" class=\"qb-counts\" style=\"display:none;\">\r\n                    <div class=\"qb-row\">\r\n                        <label>\r\n                            No. of 5 marks questions:\r\n                            <input type=\"number\" id=\"qb-ese-5\" min=\"0\" max=\"50\" value=\"0\">\r\n                        </label>\r\n                    </div>\r\n                    <div class=\"qb-row\">\r\n                        <label>\r\n                            No. of 10 marks questions:\r\n                            <input type=\"number\" id=\"qb-ese-10\" min=\"0\" max=\"50\" value=\"0\">\r\n                        </label>\r\n                    </div>\r\n                </div>\r\n\r\n                <div class=\"qb-row qb-hint\">\r\n                    <div class=\"qb-hint-title\">Type Preferences (optional)</div>\r\n                    <div class=\"qb-hint-sub\">\r\n                        Use the box below for extra preferences, e.g.\r\n                        ‚Äúfocus on trees‚Äù, ‚Äúmix all topics‚Äù, ‚Äúavoid proofs‚Äù.\r\n                        Leave it empty for a general question bank.\r\n                    </div>\r\n                </div>\r\n            </div>\r\n        `;\r\n\r\n        $('#chatbot-messages').prepend(html);\r\n\r\n        bindPanelEvents();\r\n        updateGenerateState();\r\n        loadCourses();\r\n    }\r\n\r\n    // --- AJAX LOADING: COURSES & FILE TREE ---\r\n\r\n    function loadCourses() {\r\n        $.ajax({\r\n            url: M.cfg.wwwroot + '/local/automation/qb_ajax.php',\r\n            method: 'POST',\r\n            data: JSON.stringify({\r\n                action: 'fetch_courses',\r\n                sesskey: M.cfg.sesskey\r\n            }),\r\n            contentType: 'application/json',\r\n            dataType: 'json',\r\n            success: function(res) {\r\n                if (!res || !res.success) {\r\n                    console.error('QB fetch_courses error:', res);\r\n                    return;\r\n                }\r\n                populateCourseSelect(res.courses || []);\r\n            },\r\n            error: function(xhr) {\r\n                console.error('QB fetch_courses AJAX error:', xhr);\r\n            }\r\n        });\r\n    }\r\n\r\n    function populateCourseSelect(courses) {\r\n        const $select = $('#qb-course-select');\r\n        $select.empty();\r\n        $select.append('<option value=\"\">Select course...</option>');\r\n\r\n        courses.forEach(c => {\r\n            const label = escapeHtml(c.fullname || c.shortname || ('Course ' + c.id));\r\n            $select.append(\r\n                `<option value=\"${String(c.id)}\">${label}</option>`\r\n            );\r\n        });\r\n    }\r\n\r\n    function loadFilesForCourse(courseid) {\r\n        if (!courseid) {\r\n            $('#qb-files-tree').empty();\r\n            fileMetaById = {};\r\n            selectedFileIds = [];\r\n            $('#qb-use-all-resources').prop('checked', false);\r\n            updateGenerateState();\r\n            return;\r\n        }\r\n\r\n        $.ajax({\r\n            url: M.cfg.wwwroot + '/local/automation/qb_ajax.php',\r\n            method: 'POST',\r\n            data: JSON.stringify({\r\n                action: 'fetch_files',\r\n                courseid: courseid,\r\n                sesskey: M.cfg.sesskey\r\n            }),\r\n            contentType: 'application/json',\r\n            dataType: 'json',\r\n            success: function(res) {\r\n                if (!res || !res.success) {\r\n                    console.error('QB fetch_files error:', res);\r\n                    $('#qb-files-tree').html('<div class=\"qb-info\">No files found for this course.</div>');\r\n                    fileMetaById = {};\r\n                    selectedFileIds = [];\r\n                    updateGenerateState();\r\n                    return;\r\n                }\r\n                renderFileTree(res.sections || []);\r\n            },\r\n            error: function(xhr) {\r\n                console.error('QB fetch_files AJAX error:', xhr);\r\n                $('#qb-files-tree').html('<div class=\"qb-info\">Failed to load files.</div>');\r\n                fileMetaById = {};\r\n                selectedFileIds = [];\r\n                updateGenerateState();\r\n            }\r\n        });\r\n    }\r\n\r\n    // --- TREE RENDERING ---\r\n\r\n    function renderFileTree(sections) {\r\n        fileMetaById = {};\r\n        selectedFileIds = [];\r\n        $('#qb-use-all-resources').prop('checked', false);\r\n\r\n        if (!sections.length) {\r\n            $('#qb-files-tree').html('<div class=\"qb-info\">No supported files (PDF/PPT/Word) found in this course.</div>');\r\n            updateGenerateState();\r\n            return;\r\n        }\r\n\r\n        let html = '';\r\n\r\n        sections.forEach(section => {\r\n            const sname = escapeHtml(section.name || 'Topic');\r\n            const files = Array.isArray(section.files) ? section.files : [];\r\n\r\n            if (!files.length) {\r\n                return;\r\n            }\r\n\r\n            // Build a path-based tree structure on JS side\r\n            const treeRoot = buildTreeFromFiles(section, files);\r\n\r\n            html += `\r\n                <div class=\"qb-section\">\r\n                    <div class=\"qb-section-title\">\r\n                        <span class=\"qb-icon qb-icon-section\">üìö</span>\r\n                        ${sname}\r\n                    </div>\r\n                    <div class=\"qb-section-tree\">\r\n                        ${renderTreeNode(treeRoot)}\r\n                    </div>\r\n                </div>\r\n            `;\r\n        });\r\n\r\n        if (!html) {\r\n            html = '<div class=\"qb-info\">No supported files (PDF/PPT/Word) found in this course.</div>';\r\n        }\r\n\r\n        $('#qb-files-tree').html(html);\r\n        updateGenerateState();\r\n    }\r\n\r\n    function buildTreeFromFiles(section, files) {\r\n        const root = {\r\n            type: 'root',\r\n            name: section.name || 'Section',\r\n            children: {} // key -> node\r\n        };\r\n\r\n        files.forEach(file => {\r\n            const fileid = file.fileid;\r\n            const name = file.name;\r\n            const path = file.path || name;\r\n\r\n            fileMetaById[fileid] = {\r\n                name: name,\r\n                path: path,\r\n                sectionname: section.name || '',\r\n                courseid: section.courseid || selectedCourseId\r\n            };\r\n\r\n            const parts = path.split('/').filter(Boolean);\r\n            let node = root;\r\n\r\n            // All but last are folders\r\n            for (let i = 0; i < parts.length - 1; i++) {\r\n                const folderName = parts[i];\r\n                if (!node.children[folderName]) {\r\n                    node.children[folderName] = {\r\n                        type: 'folder',\r\n                        name: folderName,\r\n                        children: {}\r\n                    };\r\n                }\r\n                node = node.children[folderName];\r\n            }\r\n\r\n            const filename = parts[parts.length - 1] || name;\r\n\r\n            // Make the key unique so files with same name don't overwrite each other\r\n            const key = filename + '__' + fileid;\r\n\r\n            node.children[key] = {\r\n                type: 'file',\r\n                name: filename,\r\n                fileid: fileid\r\n            };\r\n        });\r\n\r\n        return root;\r\n    }\r\n\r\n    function renderTreeNode(node) {\r\n        if (!node || !node.children) {\r\n            return '';\r\n        }\r\n\r\n        const keys = Object.keys(node.children);\r\n        if (!keys.length) {\r\n            return '';\r\n        }\r\n\r\n        let html = '<div class=\"qb-tree-level\">';\r\n\r\n        keys.forEach(key => {\r\n            const child = node.children[key];\r\n            if (child.type === 'folder') {\r\n                html += `\r\n                    <details class=\"qb-folder\">\r\n                        <summary>\r\n                            <span class=\"qb-icon qb-icon-folder\">üìÅ</span>\r\n                            ${escapeHtml(child.name)}\r\n                        </summary>\r\n                        ${renderTreeNode(child)}\r\n                    </details>\r\n                `;\r\n            } else if (child.type === 'file') {\r\n                const fid = String(child.fileid);\r\n                const fname = escapeHtml(child.name);\r\n                html += `\r\n                    <div class=\"qb-file\">\r\n                        <label>\r\n                            <input type=\"checkbox\" class=\"qb-file-checkbox\" data-fileid=\"${fid}\">\r\n                            <span class=\"qb-icon qb-icon-file\">üìÑ</span>\r\n                            ${fname}\r\n                        </label>\r\n                    </div>\r\n                `;\r\n            }\r\n        });\r\n\r\n        html += '</div>';\r\n        return html;\r\n    }\r\n\r\n    function recomputeSelectedFiles() {\r\n        selectedFileIds = [];\r\n        $('.qb-file-checkbox:checked').each(function() {\r\n            const fid = $(this).data('fileid');\r\n            if (fid !== undefined && fid !== null) {\r\n                selectedFileIds.push(String(fid));\r\n            }\r\n        });\r\n    }\r\n\r\n    // --- GENERATE BUTTON ENABLE/DISABLE ---\r\n\r\n    function updateGenerateState() {\r\n        const courseidVal = $('#qb-course-select').val();\r\n        selectedCourseId = courseidVal ? parseInt(courseidVal, 10) : null;\r\n\r\n        // Counts reading\r\n        counts.ia2marks   = parseInt($('#qb-ia-2').val() || '0', 10);\r\n        counts.ia5marks   = parseInt($('#qb-ia-5').val() || '0', 10);\r\n        counts.ese5marks  = parseInt($('#qb-ese-5').val() || '0', 10);\r\n        counts.ese10marks = parseInt($('#qb-ese-10').val() || '0', 10);\r\n\r\n        // Question type\r\n        const qtype = $('input[name=\"qb-qtype\"]:checked').val();\r\n        questionType = qtype || null;\r\n\r\n        let enabled = false;\r\n        const hasCourse = !!selectedCourseId;\r\n        const hasFiles = selectedFileIds.length > 0;\r\n        let hasCounts = false;\r\n\r\n        if (questionType === 'IA') {\r\n            // Default 5 & 5 IF both 0\r\n            if (counts.ia2marks === 0 && counts.ia5marks === 0) {\r\n                counts.ia2marks = 5;\r\n                counts.ia5marks = 5;\r\n                $('#qb-ia-2').val(5);\r\n                $('#qb-ia-5').val(5);\r\n            }\r\n            hasCounts = (counts.ia2marks > 0 || counts.ia5marks > 0);\r\n        } else if (questionType === 'ESE') {\r\n            // Default 5 & 5 IF both 0\r\n            if (counts.ese5marks === 0 && counts.ese10marks === 0) {\r\n                counts.ese5marks = 5;\r\n                counts.ese10marks = 5;\r\n                $('#qb-ese-5').val(5);\r\n                $('#qb-ese-10').val(5);\r\n            }\r\n            hasCounts = (counts.ese5marks > 0 || counts.ese10marks > 0);\r\n        }\r\n\r\n        enabled = hasCourse && hasFiles && !!questionType && hasCounts;\r\n\r\n        $('#chatbot-input').prop('disabled', !enabled);\r\n        $('#chatbot-send-btn').prop('disabled', !enabled);\r\n    }\r\n\r\n    // --- BIND EVENTS ---\r\n\r\n    function bindPanelEvents() {\r\n        $('#qb-course-select').on('change', function() {\r\n            const cid = $(this).val();\r\n            selectedCourseId = cid ? parseInt(cid, 10) : null;\r\n            loadFilesForCourse(selectedCourseId);\r\n            updateGenerateState();\r\n        });\r\n\r\n        $('#qb-use-all-resources').on('change', function() {\r\n            const checked = $(this).is(':checked');\r\n            $('.qb-file-checkbox').prop('checked', checked);\r\n            recomputeSelectedFiles();\r\n            updateGenerateState();\r\n        });\r\n\r\n        $('input[name=\"qb-qtype\"]').on('change', function() {\r\n            const val = $(this).val();\r\n            if (val === 'IA') {\r\n                $('#qb-counts-ia').show();\r\n                $('#qb-counts-ese').hide();\r\n            } else if (val === 'ESE') {\r\n                $('#qb-counts-ia').hide();\r\n                $('#qb-counts-ese').show();\r\n            } else {\r\n                $('#qb-counts-ia').hide();\r\n                $('#qb-counts-ese').hide();\r\n            }\r\n            updateGenerateState();\r\n        });\r\n\r\n        $('#qb-ia-2, #qb-ia-5, #qb-ese-5, #qb-ese-10').on('input', function() {\r\n            updateGenerateState();\r\n        });\r\n\r\n        // File checkbox changes (delegated)\r\n        $('#chatbot-messages').on('change', '.qb-file-checkbox', function() {\r\n            recomputeSelectedFiles();\r\n            // If not all files are selected, untick \"select all\"\r\n            const totalFiles = $('.qb-file-checkbox').length;\r\n            const totalSelected = $('.qb-file-checkbox:checked').length;\r\n            $('#qb-use-all-resources').prop('checked', totalFiles > 0 && totalFiles === totalSelected);\r\n            updateGenerateState();\r\n        });\r\n\r\n        // Download/Upload buttons (delegated)\r\n        $('#chatbot-messages')\r\n            .on('click', '.qb-download-btn', function() {\r\n                const url = $(this).data('downloadUrl');\r\n                if (url) {\r\n                    window.open(url, '_blank');\r\n                }\r\n            })\r\n            .on('click', '.qb-upload-btn', function() {\r\n                const $btn = $(this);\r\n                const fileid = $btn.data('fileid');\r\n                const courseid = $btn.data('courseid');\r\n                const qtype = $btn.data('questiontype') || questionType || 'IA';\r\n                        \r\n                if (!fileid || !courseid || $btn.prop('disabled')) {\r\n                    return;\r\n                }\r\n            \r\n                $btn.prop('disabled', true).text('Uploading...');\r\n            \r\n                $.ajax({\r\n                    url: M.cfg.wwwroot + '/local/automation/qb_ajax.php',\r\n                    method: 'POST',\r\n                    data: JSON.stringify({\r\n                        action: 'upload_qb',\r\n                        fileid: fileid,\r\n                        courseid: courseid,\r\n                        questiontype: qtype,\r\n                        sesskey: M.cfg.sesskey\r\n                    }),\r\n                    contentType: 'application/json',\r\n                    dataType: 'json',\r\n                    success: function(res) {\r\n                        if (res && res.success) {\r\n                            $btn.text('Uploaded');\r\n                        } else {\r\n                            $btn.prop('disabled', false).text('Upload failed');\r\n                            console.error('QB upload error:', res);\r\n                        }\r\n                    },\r\n                    error: function(xhr) {\r\n                        $btn.prop('disabled', false).text('Upload failed');\r\n                        console.error('QB upload AJAX error:', xhr);\r\n                        alert('Upload failed. See server logs.');\r\n                    }\r\n                });\r\n            });\r\n\r\n    }\r\n\r\n    // --- MODE ACTIVATION ---\r\n\r\n    function onModeActivated() {\r\n        ensurePanel();\r\n        $('#chatbot-send-btn').text('Generate');\r\n        editMode = false;\r\n        // We keep lastResult so edits across tab switches are possible if desired.\r\n        updateGenerateState();\r\n    }\r\n\r\n\r\n    // --- CORE: GENERATE / EDIT ---\r\n\r\n    function generate(instructions, ui) {\r\n        updateGenerateState();\r\n\r\n        if (!selectedCourseId) {\r\n            ui.appendMessage('‚ö†Ô∏è Please select a course first.', 'bot');\r\n            return;\r\n        }\r\n        if (!questionType) {\r\n            ui.appendMessage('‚ö†Ô∏è Please choose question type (IA / ESE).', 'bot');\r\n            return;\r\n        }\r\n        if (!selectedFileIds.length) {\r\n            ui.appendMessage('‚ö†Ô∏è Please select at least one file.', 'bot');\r\n            return;\r\n        }\r\n\r\n        let hasCounts = false;\r\n        if (questionType === 'IA') {\r\n            hasCounts = (counts.ia2marks > 0 || counts.ia5marks > 0);\r\n        } else if (questionType === 'ESE') {\r\n            hasCounts = (counts.ese5marks > 0 || counts.ese10marks > 0);\r\n        }\r\n        if (!hasCounts) {\r\n            ui.appendMessage('‚ö†Ô∏è Please set at least one question count.', 'bot');\r\n            return;\r\n        }\r\n\r\n        $('#qb-course-select').prop('disabled', true);\r\n        $('#qb-use-all-resources').prop('disabled', true);\r\n        $('input[name=\"qb-qtype\"]').prop('disabled', true);\r\n        $('#qb-ia-2, #qb-ia-5, #qb-ese-5, #qb-ese-10').prop('disabled', true);\r\n        $('#chatbot-input').prop('disabled', true);\r\n        $('#chatbot-send-btn').prop('disabled', true);\r\n\r\n        const trimmed = (instructions || '').trim();\r\n        if (editMode && lastResult && trimmed.length > 0) {\r\n            ui.appendMessage('‚úèÔ∏è Updating question bank...', 'bot');\r\n        } else if (!editMode) {\r\n            ui.appendMessage('‚è≥ Creating Question Bank...', 'bot');\r\n        } else {\r\n            ui.appendMessage('‚è≥ Regenerating Question Bank...', 'bot');\r\n        }\r\n\r\n        const payload = {\r\n            courseid: selectedCourseId,\r\n            selectedfiles: selectedFileIds,\r\n            filemeta: fileMetaById,  // so backend can optionally use names/paths\r\n            questiontype: questionType,\r\n            counts: counts,\r\n            instructions: instructions || '',\r\n            sesskey: M.cfg.sesskey\r\n        };\r\n\r\n        if (editMode && lastResult) {\r\n            payload.mode = 'edit';\r\n            payload.previous = lastResult;\r\n        } else {\r\n            payload.mode = 'initial';\r\n        }\r\n\r\n        $.ajax({\r\n            url: M.cfg.wwwroot + '/local/automation/qb_ajax.php',\r\n            method: 'POST',\r\n            data: JSON.stringify(payload),\r\n            contentType: 'application/json',\r\n            dataType: 'json',\r\n            success: function(res) {\r\n                console.log('QB AJAX response:', res);\r\n\r\n                if (res && res.success) {\r\n                    const downloadurl = res.downloadurl || '#';\r\n                    const fileid = res.fileid || 0;\r\n                    const courseid = res.courseid || selectedCourseId;\r\n\r\n                    lastResult = res.data || res.questions || null;\r\n                    editMode = true;\r\n\r\n                    const html = `\r\n                        <div class=\"automation-box\">\r\n                            <b>QB Generation Completed ‚úÖ</b><br>\r\n                            ${res.message ? escapeHtml(res.message) + '<br>' : ''}\r\n                            <button class=\"qb-download-btn\" data-download-url=\"${escapeHtml(downloadurl)}\">\r\n                                Download PDF\r\n                            </button>\r\n                            <button class=\"qb-upload-btn\"\r\n                                    data-fileid=\"${escapeHtml(String(fileid))}\"\r\n                                    data-courseid=\"${escapeHtml(String(courseid))}\"\r\n                                    data-questiontype=\"${escapeHtml(String(questionType || 'IA'))}\">\r\n                                Upload to course\r\n                            </button>\r\n                            <div class=\"qb-edit-hint\">\r\n                                Type any edits or modifications in the box below and click\r\n                                <b>Generate</b> again to update this Question Bank.\r\n                            </div>\r\n                        </div>\r\n                    `;\r\n\r\n                    ui.appendMessage(html, 'bot');\r\n                } else {\r\n                    ui.appendMessage(\r\n                        '‚ùå Error: ' + escapeHtml(res && res.error ? res.error : 'Unknown error'),\r\n                        'bot'\r\n                    );\r\n                }\r\n\r\n                $('#qb-course-select').prop('disabled', false);\r\n                $('#qb-use-all-resources').prop('disabled', false);\r\n                $('input[name=\"qb-qtype\"]').prop('disabled', false);\r\n                $('#qb-ia-2, #qb-ia-5, #qb-ese-5, #qb-ese-10').prop('disabled', false);\r\n                $('#chatbot-input').prop('disabled', false);\r\n                $('#chatbot-send-btn').prop('disabled', false);\r\n            },\r\n            error: function(xhr) {\r\n                console.error('QB AJAX error:', xhr);\r\n                let msg = 'Failed to generate question bank. See server logs.';\r\n                if (xhr.responseJSON && xhr.responseJSON.error) {\r\n                    msg = xhr.responseJSON.error;\r\n                }\r\n                ui.appendMessage('‚ùå ' + msg, 'bot');\r\n\r\n                $('#qb-course-select').prop('disabled', false);\r\n                $('#qb-use-all-resources').prop('disabled', false);\r\n                $('input[name=\"qb-qtype\"]').prop('disabled', false);\r\n                $('#qb-ia-2, #qb-ia-5, #qb-ese-5, #qb-ese-10').prop('disabled', false);\r\n                $('#chatbot-input').prop('disabled', false);\r\n                $('#chatbot-send-btn').prop('disabled', false);\r\n            }\r\n        });\r\n    }\r\n\r\n    return {\r\n        beforeSend: beforeSend,\r\n        handleResponse: handleResponse,\r\n        reset: reset,\r\n        onModeActivated: onModeActivated,\r\n        generate: generate\r\n    };\r\n});\r\n"],"names":["define","$","selectedCourseId","questionType","counts","ia2marks","ia5marks","ese5marks","ese10marks","fileMetaById","selectedFileIds","editMode","lastResult","escapeHtml","str","String","replace","ensurePanel","length","prepend","on","cid","this","val","parseInt","courseid","empty","prop","updateGenerateState","ajax","url","M","cfg","wwwroot","method","data","JSON","stringify","action","sesskey","contentType","dataType","success","res","console","error","html","sections","forEach","section","sname","name","files","Array","isArray","treeRoot","root","type","children","file","fileid","path","sectionname","parts","split","filter","Boolean","node","i","folderName","filename","key","buildTreeFromFiles","renderTreeNode","renderFileTree","xhr","loadFilesForCourse","checked","is","recomputeSelectedFiles","show","hide","totalFiles","totalSelected","window","open","$btn","qtype","text","questiontype","alert","courses","$select","append","c","label","fullname","shortname","id","populateCourseSelect","keys","Object","child","fid","fname","each","push","courseidVal","enabled","hasCourse","hasFiles","hasCounts","beforeSend","handleResponse","ui","reset","remove","onModeActivated","generate","instructions","appendMessage","trimmed","trim","payload","selectedfiles","filemeta","mode","previous","log","downloadurl","questions","message","msg","responseJSON"],"mappings":"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"}