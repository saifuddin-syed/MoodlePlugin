{"version":3,"file":"chat_qb.min.js","sources":["../src/chat_qb.js"],"sourcesContent":["// local/automation/amd/src/chat_qb.js\r\ndefine(['jquery'], function($) {\r\n    'use strict';\r\n\r\n    // --- State ---\r\n\r\n    let selectedCourseId = null;\r\n    let questionType = null; // 'IA' or 'ESE'\r\n\r\n    let counts = {\r\n        ia2marks: 0,\r\n        ia5marks: 0,\r\n        ese5marks: 0,\r\n        ese10marks: 0\r\n    };\r\n\r\n    // File selection\r\n    let fileMetaById = {};      // fileid -> { name, path, sectionname, courseid }\r\n    let selectedFileIds = [];   // array of selected fileids\r\n\r\n    // Edit flow state\r\n    let editMode = false;       // true after first successful generation\r\n    let lastResult = null;      // whatever qb_ajax returns to represent last QB\r\n\r\n    // --- Helpers shared with chatbot.js ---\r\n\r\n    function reset() {\r\n        selectedCourseId = null;\r\n        questionType = null;\r\n\r\n        counts = {\r\n            ia2marks: 0,\r\n            ia5marks: 0,\r\n            ese5marks: 0,\r\n            ese10marks: 0\r\n        };\r\n\r\n        fileMetaById = {};\r\n        selectedFileIds = [];\r\n        editMode = false;\r\n        lastResult = null;\r\n\r\n        $('#qb-panel').remove();\r\n        $('#qb-controls-fab').remove();\r\n        $('#chatbot-messages').off('.qb');\r\n\r\n        $('#chatbot-input').prop('disabled', false);\r\n        $('#chatbot-send-btn').prop('disabled', false).text('Send');\r\n    }\r\n\r\n    function beforeSend(text) {\r\n        // Not used for QB; chatbot.js calls generate() directly.\r\n        return text;\r\n    }\r\n\r\n    function handleResponse(res, ui) {\r\n        // QB does not consume chatbot_endpoint.php responses.\r\n        return false;\r\n    }\r\n\r\n    // Escape HTML helper to avoid XSS\r\n    function escapeHtml(str) {\r\n        if (str === null || str === undefined) return '';\r\n        return String(str)\r\n            .replace(/&/g, '&amp;')\r\n            .replace(/</g, '&lt;')\r\n            .replace(/>/g, '&gt;')\r\n            .replace(/\"/g, '&quot;')\r\n            .replace(/'/g, '&#039;');\r\n    }\r\n\r\n    // --- INLINE STYLING FOR QB PANEL (so we ignore theme CSS) ---\r\n\r\n    function applyQbInlineStyles() {\r\n        const $panel = $('#qb-panel');\r\n        if (!$panel.length) return;\r\n\r\n        // Keep panel pinned at top of messages area\r\n        $panel.css({\r\n            zIndex: 10,\r\n            background: '#ffffff',\r\n            padding: '8px 10px 10px 10px',\r\n            borderBottom: '1px solid #e0e0e0',\r\n            boxShadow: '0 2px 4px rgba(0,0,0,0.04)'\r\n        });\r\n\r\n        $('.qb-row', $panel).css({\r\n            marginBottom: '6px',\r\n            display: 'flex',\r\n            flexWrap: 'wrap',\r\n            alignItems: 'center',\r\n            gap: '6px'\r\n        });\r\n\r\n        $('#qb-panel label').css({\r\n            fontSize: '0.8rem'\r\n        });\r\n\r\n        // Modern select / number inputs\r\n        $('#qb-course-select, #qb-ia-2, #qb-ia-5, #qb-ese-5, #qb-ese-10').css({\r\n            padding: '4px 8px',\r\n            borderRadius: '6px',\r\n            border: '1px solid #d0d0d0',\r\n            background: '#fafafa',\r\n            fontSize: '0.8rem'\r\n        });\r\n\r\n        // Question type radios as pills\r\n        $('.qb-qtype-group', $panel).css({\r\n            display: 'flex',\r\n            gap: '12px',\r\n            fontSize: '0.8rem'\r\n        });\r\n\r\n        $('.qb-qtype-group label', $panel).css({\r\n            display: 'flex',\r\n            alignItems: 'center',\r\n            gap: '6px',\r\n            padding: '4px 8px',\r\n            borderRadius: '999px',\r\n            border: '1px solid #e0e0e0',\r\n            cursor: 'pointer',\r\n            background: '#ffffff'\r\n        });\r\n\r\n        $('.qb-qtype-group input[type=\"radio\"]', $panel).css({\r\n            accentColor: '#1976d2'\r\n        });\r\n\r\n        // File explorer tree box\r\n        $('#qb-files-tree').css({\r\n            width: '100%',\r\n            maxHeight: '220px',\r\n            overflow: 'auto',\r\n            padding: '6px 8px',\r\n            borderRadius: '8px',\r\n            border: '1px solid #e0e0e0',\r\n            background: '#fafafa',\r\n            fontSize: '0.8rem'\r\n        });\r\n\r\n        $('.qb-section-title').css({\r\n            fontWeight: 600,\r\n            marginBottom: '3px',\r\n            display: 'flex',\r\n            alignItems: 'center',\r\n            gap: '6px',\r\n            color: '#37474f'\r\n        });\r\n\r\n        $('.qb-folder').css({\r\n            marginLeft: '8px'\r\n        });\r\n\r\n        $('.qb-folder > summary').css({\r\n            listStyle: 'none',\r\n            cursor: 'pointer',\r\n            padding: '3px 6px',\r\n            borderRadius: '4px',\r\n            display: 'flex',\r\n            alignItems: 'center',\r\n            gap: '6px'\r\n        });\r\n\r\n        $('.qb-tree-level').css({\r\n            marginLeft: '14px',\r\n            paddingLeft: '4px',\r\n            borderLeft: '1px dashed #d0d0d0'\r\n        });\r\n\r\n        $('.qb-file label').css({\r\n            display: 'flex',\r\n            alignItems: 'center',\r\n            gap: '6px',\r\n            padding: '2px 6px',\r\n            borderRadius: '4px',\r\n            cursor: 'pointer'\r\n        });\r\n\r\n        $('.qb-file input[type=\"checkbox\"]').css({\r\n            accentColor: '#1976d2'\r\n        });\r\n\r\n        // Hint box\r\n        $('.qb-hint').css({\r\n            flexDirection: 'column',\r\n            alignItems: 'flex-start',\r\n            padding: '6px 8px',\r\n            borderRadius: '6px',\r\n            background: '#f5f5f5'\r\n        });\r\n\r\n        $('.qb-hint-title').css({\r\n            fontWeight: 600,\r\n            fontSize: '0.8rem',\r\n            marginBottom: '2px'\r\n        });\r\n\r\n        $('.qb-hint-sub').css({\r\n            fontSize: '0.75rem',\r\n            color: '#555'\r\n        });\r\n    }\r\n\r\n    // --- UI PANEL CREATION ---\r\n\r\n    function ensurePanel() {\r\n        if ($('#qb-panel').length) {\r\n            return;\r\n        }\r\n\r\n        const html = `\r\n            <div id=\"qb-panel\" class=\"qb-panel\">\r\n                <div class=\"qb-row\">\r\n                    <label>Subject (course)</label>\r\n                    <select id=\"qb-course-select\">\r\n                        <option value=\"\">Select course...</option>\r\n                        <!-- Options will be loaded via AJAX -->\r\n                    </select>\r\n                </div>\r\n\r\n                <div class=\"qb-row\" id=\"qb-topics-container\">\r\n                    <div class=\"qb-row\">\r\n                        <label>\r\n                            <input type=\"checkbox\" id=\"qb-use-all-resources\">\r\n                            Select all supported files (PDF / PPT / Word)\r\n                        </label>\r\n                    </div>\r\n                    <div id=\"qb-files-tree\" class=\"qb-files-tree\">\r\n                        <!-- Sections + folders + files will be rendered here -->\r\n                    </div>\r\n                </div>\r\n\r\n                <div class=\"qb-row\">\r\n                    <label>Question type</label>\r\n                    <div class=\"qb-qtype-group\">\r\n                        <label>\r\n                            <input type=\"radio\" name=\"qb-qtype\" value=\"IA\">\r\n                            <span>IA Type (2 marks &amp; 5 marks)</span>\r\n                        </label>\r\n                        <label>\r\n                            <input type=\"radio\" name=\"qb-qtype\" value=\"ESE\">\r\n                            <span>ESE Type (5 marks &amp; 10 marks)</span>\r\n                        </label>\r\n                    </div>\r\n                </div>\r\n\r\n                <div id=\"qb-counts-ia\" class=\"qb-counts\" style=\"display:none;\">\r\n                    <div class=\"qb-row\">\r\n                        <label>\r\n                            No. of 2 marks questions:\r\n                            <input type=\"number\" id=\"qb-ia-2\" min=\"0\" max=\"50\" value=\"0\">\r\n                        </label>\r\n                    </div>\r\n                    <div class=\"qb-row\">\r\n                        <label>\r\n                            No. of 5 marks questions:\r\n                            <input type=\"number\" id=\"qb-ia-5\" min=\"0\" max=\"50\" value=\"0\">\r\n                        </label>\r\n                    </div>\r\n                </div>\r\n\r\n                <div id=\"qb-counts-ese\" class=\"qb-counts\" style=\"display:none;\">\r\n                    <div class=\"qb-row\">\r\n                        <label>\r\n                            No. of 5 marks questions:\r\n                            <input type=\"number\" id=\"qb-ese-5\" min=\"0\" max=\"50\" value=\"0\">\r\n                        </label>\r\n                    </div>\r\n                    <div class=\"qb-row\">\r\n                        <label>\r\n                            No. of 10 marks questions:\r\n                            <input type=\"number\" id=\"qb-ese-10\" min=\"0\" max=\"50\" value=\"0\">\r\n                        </label>\r\n                    </div>\r\n                </div>\r\n\r\n                <div class=\"qb-row qb-hint\">\r\n                    <div class=\"qb-hint-title\">Type Preferences (optional)</div>\r\n                    <div class=\"qb-hint-sub\">\r\n                        Use the box below for extra preferences, e.g.\r\n                        ‚Äúfocus on trees‚Äù, ‚Äúmix all topics‚Äù, ‚Äúavoid proofs‚Äù.\r\n                        Leave it empty for a general question bank.\r\n                    </div>\r\n                </div>\r\n            </div>\r\n        `;\r\n\r\n        $('#chatbot-messages').prepend(html);\r\n\r\n        // Add floating \"Controls ‚Üë\" button once per chat window\r\n        if (!$('#qb-controls-fab').length) {\r\n            $('#chatbot-messages').append(`\r\n                <button id=\"qb-controls-fab\" title=\"Back to controls\">\r\n                    ‚ñ≤ Controls\r\n                </button>\r\n            `);\r\n        }\r\n\r\n        // Apply inline styles so Moodle theme can't override them\r\n        applyQbInlineStyles();\r\n\r\n        bindPanelEvents();\r\n        updateGenerateState();\r\n        loadCourses();\r\n    }\r\n\r\n    // --- AJAX LOADING: COURSES & FILE TREE ---\r\n\r\n    function loadCourses() {\r\n        $.ajax({\r\n            url: M.cfg.wwwroot + '/local/automation/qb_ajax.php',\r\n            method: 'POST',\r\n            data: JSON.stringify({\r\n                action: 'fetch_courses',\r\n                sesskey: M.cfg.sesskey\r\n            }),\r\n            contentType: 'application/json',\r\n            dataType: 'json',\r\n            success: function(res) {\r\n                if (!res || !res.success) {\r\n                    console.error('QB fetch_courses error:', res);\r\n                    return;\r\n                }\r\n                populateCourseSelect(res.courses || []);\r\n            },\r\n            error: function(xhr) {\r\n                console.error('QB fetch_courses AJAX error:', xhr);\r\n            }\r\n        });\r\n    }\r\n\r\n    function populateCourseSelect(courses) {\r\n        const $select = $('#qb-course-select');\r\n        $select.empty();\r\n        $select.append('<option value=\"\">Select course...</option>');\r\n\r\n        courses.forEach(c => {\r\n            const label = escapeHtml(c.fullname || c.shortname || ('Course ' + c.id));\r\n            $select.append(\r\n                `<option value=\"${String(c.id)}\">${label}</option>`\r\n            );\r\n        });\r\n    }\r\n\r\n    function loadFilesForCourse(courseid) {\r\n        if (!courseid) {\r\n            $('#qb-files-tree').empty();\r\n            fileMetaById = {};\r\n            selectedFileIds = [];\r\n            $('#qb-use-all-resources').prop('checked', false);\r\n            updateGenerateState();\r\n            return;\r\n        }\r\n\r\n        $.ajax({\r\n            url: M.cfg.wwwroot + '/local/automation/qb_ajax.php',\r\n            method: 'POST',\r\n            data: JSON.stringify({\r\n                action: 'fetch_files',\r\n                courseid: courseid,\r\n                sesskey: M.cfg.sesskey\r\n            }),\r\n            contentType: 'application/json',\r\n            dataType: 'json',\r\n            success: function(res) {\r\n                if (!res || !res.success) {\r\n                    console.error('QB fetch_files error:', res);\r\n                    $('#qb-files-tree').html('<div class=\"qb-info\">No files found for this course.</div>');\r\n                    fileMetaById = {};\r\n                    selectedFileIds = [];\r\n                    updateGenerateState();\r\n                    return;\r\n                }\r\n                renderFileTree(res.sections || []);\r\n            },\r\n            error: function(xhr) {\r\n                console.error('QB fetch_files AJAX error:', xhr);\r\n                $('#qb-files-tree').html('<div class=\"qb-info\">Failed to load files.</div>');\r\n                fileMetaById = {};\r\n                selectedFileIds = [];\r\n                updateGenerateState();\r\n            }\r\n        });\r\n    }\r\n\r\n    // --- TREE RENDERING ---\r\n\r\n    function renderFileTree(sections) {\r\n        fileMetaById = {};\r\n        selectedFileIds = [];\r\n        $('#qb-use-all-resources').prop('checked', false);\r\n\r\n        if (!sections.length) {\r\n            $('#qb-files-tree').html('<div class=\"qb-info\">No supported files (PDF/PPT/Word) found in this course.</div>');\r\n            updateGenerateState();\r\n            return;\r\n        }\r\n\r\n        let html = '';\r\n\r\n        sections.forEach(section => {\r\n            const sname = escapeHtml(section.name || 'Topic');\r\n            const files = Array.isArray(section.files) ? section.files : [];\r\n\r\n            if (!files.length) {\r\n                return;\r\n            }\r\n\r\n            const treeRoot = buildTreeFromFiles(section, files);\r\n\r\n            html += `\r\n                <div class=\"qb-section\">\r\n                    <div class=\"qb-section-title\">\r\n                        <span class=\"qb-icon qb-icon-section\">üìö</span>\r\n                        ${sname}\r\n                    </div>\r\n                    <div class=\"qb-section-tree\">\r\n                        ${renderTreeNode(treeRoot)}\r\n                    </div>\r\n                </div>\r\n            `;\r\n        });\r\n\r\n        if (!html) {\r\n            html = '<div class=\"qb-info\">No supported files (PDF/PPT/Word) found in this course.</div>';\r\n        }\r\n\r\n        $('#qb-files-tree').html(html);\r\n\r\n        // Re-apply tree related styles now that new nodes exist\r\n        applyQbInlineStyles();\r\n        updateGenerateState();\r\n    }\r\n\r\n    function buildTreeFromFiles(section, files) {\r\n        const root = {\r\n            type: 'root',\r\n            name: section.name || 'Section',\r\n            children: {}\r\n        };\r\n\r\n        files.forEach(file => {\r\n            const fileid = file.fileid;\r\n            const name = file.name;\r\n            const path = file.path || name;\r\n\r\n            fileMetaById[fileid] = {\r\n                name: name,\r\n                path: path,\r\n                sectionname: section.name || '',\r\n                courseid: section.courseid || selectedCourseId\r\n            };\r\n\r\n            const parts = path.split('/').filter(Boolean);\r\n            let node = root;\r\n\r\n            for (let i = 0; i < parts.length - 1; i++) {\r\n                const folderName = parts[i];\r\n                if (!node.children[folderName]) {\r\n                    node.children[folderName] = {\r\n                        type: 'folder',\r\n                        name: folderName,\r\n                        children: {}\r\n                    };\r\n                }\r\n                node = node.children[folderName];\r\n            }\r\n\r\n            const filename = parts[parts.length - 1] || name;\r\n            const key = filename + '__' + fileid;\r\n\r\n            node.children[key] = {\r\n                type: 'file',\r\n                name: filename,\r\n                fileid: fileid\r\n            };\r\n        });\r\n\r\n        return root;\r\n    }\r\n\r\n    function renderTreeNode(node) {\r\n        if (!node || !node.children) {\r\n            return '';\r\n        }\r\n\r\n        const keys = Object.keys(node.children);\r\n        if (!keys.length) {\r\n            return '';\r\n        }\r\n\r\n        let html = '<div class=\"qb-tree-level\">';\r\n\r\n        keys.forEach(key => {\r\n            const child = node.children[key];\r\n            if (child.type === 'folder') {\r\n                html += `\r\n                    <details class=\"qb-folder\">\r\n                        <summary>\r\n                            <span class=\"qb-icon qb-icon-folder\">üìÅ</span>\r\n                            ${escapeHtml(child.name)}\r\n                        </summary>\r\n                        ${renderTreeNode(child)}\r\n                    </details>\r\n                `;\r\n            } else if (child.type === 'file') {\r\n                const fid = String(child.fileid);\r\n                const fname = escapeHtml(child.name);\r\n                html += `\r\n                    <div class=\"qb-file\">\r\n                        <label>\r\n                            <input type=\"checkbox\" class=\"qb-file-checkbox\" data-fileid=\"${fid}\">\r\n                            <span class=\"qb-icon qb-icon-file\">üìÑ</span>\r\n                            ${fname}\r\n                        </label>\r\n                    </div>\r\n                `;\r\n            }\r\n        });\r\n\r\n        html += '</div>';\r\n        return html;\r\n    }\r\n\r\n    function recomputeSelectedFiles() {\r\n        selectedFileIds = [];\r\n        $('.qb-file-checkbox:checked').each(function() {\r\n            const fid = $(this).data('fileid');\r\n            if (fid !== undefined && fid !== null) {\r\n                selectedFileIds.push(String(fid));\r\n            }\r\n        });\r\n    }\r\n\r\n    // --- GENERATE BUTTON ENABLE/DISABLE ---\r\n\r\n    function updateGenerateState() {\r\n        const courseidVal = $('#qb-course-select').val();\r\n        selectedCourseId = courseidVal ? parseInt(courseidVal, 10) : null;\r\n\r\n        counts.ia2marks   = parseInt($('#qb-ia-2').val() || '0', 10);\r\n        counts.ia5marks   = parseInt($('#qb-ia-5').val() || '0', 10);\r\n        counts.ese5marks  = parseInt($('#qb-ese-5').val() || '0', 10);\r\n        counts.ese10marks = parseInt($('#qb-ese-10').val() || '0', 10);\r\n\r\n        const qtype = $('input[name=\"qb-qtype\"]:checked').val();\r\n        questionType = qtype || null;\r\n\r\n        let enabled = false;\r\n        const hasCourse = !!selectedCourseId;\r\n        const hasFiles = selectedFileIds.length > 0;\r\n        let hasCounts = false;\r\n\r\n        if (questionType === 'IA') {\r\n            if (counts.ia2marks === 0 && counts.ia5marks === 0) {\r\n                counts.ia2marks = 5;\r\n                counts.ia5marks = 5;\r\n                $('#qb-ia-2').val(5);\r\n                $('#qb-ia-5').val(5);\r\n            }\r\n            hasCounts = (counts.ia2marks > 0 || counts.ia5marks > 0);\r\n        } else if (questionType === 'ESE') {\r\n            if (counts.ese5marks === 0 && counts.ese10marks === 0) {\r\n                counts.ese5marks = 5;\r\n                counts.ese10marks = 5;\r\n                $('#qb-ese-5').val(5);\r\n                $('#qb-ese-10').val(5);\r\n            }\r\n            hasCounts = (counts.ese5marks > 0 || counts.ese10marks > 0);\r\n        }\r\n\r\n        enabled = hasCourse && hasFiles && !!questionType && hasCounts;\r\n\r\n        $('#chatbot-input').prop('disabled', !enabled);\r\n        $('#chatbot-send-btn').prop('disabled', !enabled);\r\n    }\r\n\r\n    // --- BIND EVENTS ---\r\n\r\n    function bindPanelEvents() {\r\n        const $messages = $('#chatbot-messages');\r\n\r\n        // Show/hide FAB depending on scroll position\r\n        $messages.on('scroll.qb', function() {\r\n            const $fab = $('#qb-controls-fab');\r\n            if (!$fab.length) return;\r\n\r\n            if (this.scrollTop > 150) {\r\n                $fab.fadeIn(150);\r\n            } else {\r\n                $fab.fadeOut(150);\r\n            }\r\n        });\r\n\r\n        // Scroll back to top (controls) when FAB clicked\r\n        $messages.on('click.qb', '#qb-controls-fab', function() {\r\n            $messages.animate({ scrollTop: 0 }, 200);\r\n        });\r\n\r\n        $('#qb-course-select').on('change', function() {\r\n            const cid = $(this).val();\r\n            selectedCourseId = cid ? parseInt(cid, 10) : null;\r\n            loadFilesForCourse(selectedCourseId);\r\n            updateGenerateState();\r\n        });\r\n\r\n        $('#qb-use-all-resources').on('change', function() {\r\n            const checked = $(this).is(':checked');\r\n            $('.qb-file-checkbox').prop('checked', checked);\r\n            recomputeSelectedFiles();\r\n            updateGenerateState();\r\n        });\r\n\r\n        $('input[name=\"qb-qtype\"]').on('change', function() {\r\n            const val = $(this).val();\r\n            if (val === 'IA') {\r\n                $('#qb-counts-ia').show();\r\n                $('#qb-counts-ese').hide();\r\n            } else if (val === 'ESE') {\r\n                $('#qb-counts-ia').hide();\r\n                $('#qb-counts-ese').show();\r\n            } else {\r\n                $('#qb-counts-ia').hide();\r\n                $('#qb-counts-ese').hide();\r\n            }\r\n            updateGenerateState();\r\n        });\r\n\r\n        $('#qb-ia-2, #qb-ia-5, #qb-ese-5, #qb-ese-10').on('input', function() {\r\n            updateGenerateState();\r\n        });\r\n\r\n        $('#chatbot-messages').on('change', '.qb-file-checkbox', function() {\r\n            recomputeSelectedFiles();\r\n            const totalFiles = $('.qb-file-checkbox').length;\r\n            const totalSelected = $('.qb-file-checkbox:checked').length;\r\n            $('#qb-use-all-resources').prop('checked', totalFiles > 0 && totalFiles === totalSelected);\r\n            updateGenerateState();\r\n        });\r\n\r\n        $('#chatbot-messages')\r\n            .on('click', '.qb-download-btn', function() {\r\n                const url = $(this).data('downloadUrl');\r\n                if (url) {\r\n                    window.open(url, '_blank');\r\n                }\r\n            })\r\n            .on('click', '.qb-upload-btn', function() {\r\n                const $btn = $(this);\r\n                const fileid = $btn.data('fileid');\r\n                const courseid = $btn.data('courseid');\r\n                const qtype = $btn.data('questiontype') || questionType || 'IA';\r\n\r\n                if (!fileid || !courseid || $btn.prop('disabled')) {\r\n                    return;\r\n                }\r\n\r\n                $btn.prop('disabled', true).text('Uploading...');\r\n\r\n                $.ajax({\r\n                    url: M.cfg.wwwroot + '/local/automation/qb_ajax.php',\r\n                    method: 'POST',\r\n                    data: JSON.stringify({\r\n                        action: 'upload_qb',\r\n                        fileid: fileid,\r\n                        courseid: courseid,\r\n                        questiontype: qtype,\r\n                        sesskey: M.cfg.sesskey\r\n                    }),\r\n                    contentType: 'application/json',\r\n                    dataType: 'json',\r\n                    success: function(res) {\r\n                        if (res && res.success) {\r\n                            $btn.text('Uploaded');\r\n                        } else {\r\n                            $btn.prop('disabled', false).text('Upload failed');\r\n                            console.error('QB upload error:', res);\r\n                        }\r\n                    },\r\n                    error: function(xhr) {\r\n                        $btn.prop('disabled', false).text('Upload failed');\r\n                        console.error('QB upload AJAX error:', xhr);\r\n                        alert('Upload failed. See server logs.');\r\n                    }\r\n                });\r\n            });\r\n    }\r\n\r\n    // --- MODE ACTIVATION ---\r\n\r\n    function onModeActivated() {\r\n        ensurePanel();\r\n        $('#chatbot-send-btn').text('Generate');\r\n        editMode = false;\r\n        updateGenerateState();\r\n    }\r\n\r\n    // --- CORE: GENERATE / EDIT ---\r\n\r\n    function generate(instructions, ui) {\r\n        updateGenerateState();\r\n\r\n        if (!selectedCourseId) {\r\n            ui.appendMessage('‚ö†Ô∏è Please select a course first.', 'bot');\r\n            return;\r\n        }\r\n        if (!questionType) {\r\n            ui.appendMessage('‚ö†Ô∏è Please choose question type (IA / ESE).', 'bot');\r\n            return;\r\n        }\r\n        if (!selectedFileIds.length) {\r\n            ui.appendMessage('‚ö†Ô∏è Please select at least one file.', 'bot');\r\n            return;\r\n        }\r\n\r\n        let hasCounts = false;\r\n        if (questionType === 'IA') {\r\n            hasCounts = (counts.ia2marks > 0 || counts.ia5marks > 0);\r\n        } else if (questionType === 'ESE') {\r\n            hasCounts = (counts.ese5marks > 0 || counts.ese10marks > 0);\r\n        }\r\n        if (!hasCounts) {\r\n            ui.appendMessage('‚ö†Ô∏è Please set at least one question count.', 'bot');\r\n            return;\r\n        }\r\n\r\n        $('#qb-course-select').prop('disabled', true);\r\n        $('#qb-use-all-resources').prop('disabled', true);\r\n        $('input[name=\"qb-qtype\"]').prop('disabled', true);\r\n        $('#qb-ia-2, #qb-ia-5, #qb-ese-5, #qb-ese-10').prop('disabled', true);\r\n        $('#chatbot-input').prop('disabled', true);\r\n        $('#chatbot-send-btn').prop('disabled', true);\r\n\r\n        const trimmed = (instructions || '').trim();\r\n        if (editMode && lastResult && trimmed.length > 0) {\r\n            ui.appendMessage('‚úèÔ∏è Updating question bank...', 'bot');\r\n        } else if (!editMode) {\r\n            ui.appendMessage('‚è≥ Creating Question Bank...', 'bot');\r\n        } else {\r\n            ui.appendMessage('‚è≥ Regenerating Question Bank...', 'bot');\r\n        }\r\n\r\n        const payload = {\r\n            courseid: selectedCourseId,\r\n            selectedfiles: selectedFileIds,\r\n            filemeta: fileMetaById,\r\n            questiontype: questionType,\r\n            counts: counts,\r\n            instructions: instructions || '',\r\n            sesskey: M.cfg.sesskey\r\n        };\r\n\r\n        if (editMode && lastResult) {\r\n            payload.mode = 'edit';\r\n            payload.previous = lastResult;\r\n        } else {\r\n            payload.mode = 'initial';\r\n        }\r\n\r\n        $.ajax({\r\n            url: M.cfg.wwwroot + '/local/automation/qb_ajax.php',\r\n            method: 'POST',\r\n            data: JSON.stringify(payload),\r\n            contentType: 'application/json',\r\n            dataType: 'json',\r\n            success: function(res) {\r\n                console.log('QB AJAX response:', res);\r\n\r\n                if (res && res.success) {\r\n                    const downloadurl = res.downloadurl || '#';\r\n                    const fileid = res.fileid || 0;\r\n                    const courseid = res.courseid || selectedCourseId;\r\n\r\n                    lastResult = res.data || res.questions || null;\r\n                    editMode = true;\r\n\r\n                    const html = `\r\n                        <div class=\"automation-box\">\r\n                            <b>QB Generation Completed ‚úÖ</b><br>\r\n                            ${res.message ? escapeHtml(res.message) + '<br>' : ''}\r\n                            <button class=\"qb-download-btn\" data-download-url=\"${escapeHtml(downloadurl)}\">\r\n                                Download PDF\r\n                            </button>\r\n                            <button class=\"qb-upload-btn\"\r\n                                    data-fileid=\"${escapeHtml(String(fileid))}\"\r\n                                    data-courseid=\"${escapeHtml(String(courseid))}\"\r\n                                    data-questiontype=\"${escapeHtml(String(questionType || 'IA'))}\">\r\n                                Upload to course\r\n                            </button>\r\n                            <div class=\"qb-edit-hint\">\r\n                                Type any edits or modifications in the box below and click\r\n                                <b>Generate</b> again to update this Question Bank.\r\n                            </div>\r\n                        </div>\r\n                    `;\r\n\r\n                    ui.appendMessage(html, 'bot');\r\n                } else {\r\n                    ui.appendMessage(\r\n                        '‚ùå Error: ' + escapeHtml(res && res.error ? res.error : 'Unknown error'),\r\n                        'bot'\r\n                    );\r\n                }\r\n\r\n                $('#qb-course-select').prop('disabled', false);\r\n                $('#qb-use-all-resources').prop('disabled', false);\r\n                $('input[name=\"qb-qtype\"]').prop('disabled', false);\r\n                $('#qb-ia-2, #qb-ia-5, #qb-ese-5, #qb-ese-10').prop('disabled', false);\r\n                $('#chatbot-input').prop('disabled', false);\r\n                $('#chatbot-send-btn').prop('disabled', false);\r\n            },\r\n            error: function(xhr) {\r\n                console.error('QB AJAX error:', xhr);\r\n                let msg = 'Failed to generate question bank. See server logs.';\r\n                if (xhr.responseJSON && xhr.responseJSON.error) {\r\n                    msg = xhr.responseJSON.error;\r\n                }\r\n                ui.appendMessage('‚ùå ' + msg, 'bot');\r\n\r\n                $('#qb-course-select').prop('disabled', false);\r\n                $('#qb-use-all-resources').prop('disabled', false);\r\n                $('input[name=\"qb-qtype\"]').prop('disabled', false);\r\n                $('#qb-ia-2, #qb-ia-5, #qb-ese-5, #qb-ese-10').prop('disabled', false);\r\n                $('#chatbot-input').prop('disabled', false);\r\n                $('#chatbot-send-btn').prop('disabled', false);\r\n            }\r\n        });\r\n    }\r\n\r\n    return {\r\n        beforeSend: beforeSend,\r\n        handleResponse: handleResponse,\r\n        reset: reset,\r\n        onModeActivated: onModeActivated,\r\n        generate: generate\r\n    };\r\n});\r\n"],"names":["define","$","selectedCourseId","questionType","counts","ia2marks","ia5marks","ese5marks","ese10marks","fileMetaById","selectedFileIds","editMode","lastResult","escapeHtml","str","String","replace","applyQbInlineStyles","$panel","length","css","zIndex","background","padding","borderBottom","boxShadow","marginBottom","display","flexWrap","alignItems","gap","fontSize","borderRadius","border","cursor","accentColor","width","maxHeight","overflow","fontWeight","color","marginLeft","listStyle","paddingLeft","borderLeft","flexDirection","ensurePanel","prepend","append","$messages","on","$fab","this","scrollTop","fadeIn","fadeOut","animate","cid","val","parseInt","courseid","empty","prop","updateGenerateState","ajax","url","M","cfg","wwwroot","method","data","JSON","stringify","action","sesskey","contentType","dataType","success","res","console","error","html","sections","forEach","section","sname","name","files","Array","isArray","treeRoot","root","type","children","file","fileid","path","sectionname","parts","split","filter","Boolean","node","i","folderName","filename","key","buildTreeFromFiles","renderTreeNode","renderFileTree","xhr","loadFilesForCourse","checked","is","recomputeSelectedFiles","show","hide","totalFiles","totalSelected","window","open","$btn","qtype","text","questiontype","alert","bindPanelEvents","courses","$select","c","label","fullname","shortname","id","populateCourseSelect","keys","Object","child","fid","fname","each","push","courseidVal","enabled","hasCourse","hasFiles","hasCounts","beforeSend","handleResponse","ui","reset","remove","off","onModeActivated","generate","instructions","appendMessage","trimmed","trim","payload","selectedfiles","filemeta","mode","previous","log","downloadurl","questions","message","msg","responseJSON"],"mappings":"AACAA,kCAAO,CAAC,WAAW,SAASC,OAKpBC,iBAAmB,KACnBC,aAAe,KAEfC,OAAS,CACTC,SAAU,EACVC,SAAU,EACVC,UAAW,EACXC,WAAY,GAIZC,aAAe,GACfC,gBAAkB,GAGlBC,UAAW,EACXC,WAAa,cAuCRC,WAAWC,YACZA,MAAAA,IAA0C,GACvCC,OAAOD,KACTE,QAAQ,KAAM,SACdA,QAAQ,KAAM,QACdA,QAAQ,KAAM,QACdA,QAAQ,KAAM,UACdA,QAAQ,KAAM,mBAKdC,4BACCC,OAASjB,EAAE,aACZiB,OAAOC,SAGZD,OAAOE,IAAI,CACPC,OAAQ,GACRC,WAAY,UACZC,QAAS,qBACTC,aAAc,oBACdC,UAAW,+BAGfxB,EAAE,UAAWiB,QAAQE,IAAI,CACrBM,aAAc,MACdC,QAAS,OACTC,SAAU,OACVC,WAAY,SACZC,IAAK,QAGT7B,EAAE,mBAAmBmB,IAAI,CACrBW,SAAU,WAId9B,EAAE,gEAAgEmB,IAAI,CAClEG,QAAS,UACTS,aAAc,MACdC,OAAQ,oBACRX,WAAY,UACZS,SAAU,WAId9B,EAAE,kBAAmBiB,QAAQE,IAAI,CAC7BO,QAAS,OACTG,IAAK,OACLC,SAAU,WAGd9B,EAAE,wBAAyBiB,QAAQE,IAAI,CACnCO,QAAS,OACTE,WAAY,SACZC,IAAK,MACLP,QAAS,UACTS,aAAc,QACdC,OAAQ,oBACRC,OAAQ,UACRZ,WAAY,YAGhBrB,EAAE,sCAAuCiB,QAAQE,IAAI,CACjDe,YAAa,YAIjBlC,EAAE,kBAAkBmB,IAAI,CACpBgB,MAAO,OACPC,UAAW,QACXC,SAAU,OACVf,QAAS,UACTS,aAAc,MACdC,OAAQ,oBACRX,WAAY,UACZS,SAAU,WAGd9B,EAAE,qBAAqBmB,IAAI,CACvBmB,WAAY,IACZb,aAAc,MACdC,QAAS,OACTE,WAAY,SACZC,IAAK,MACLU,MAAO,YAGXvC,EAAE,cAAcmB,IAAI,CAChBqB,WAAY,QAGhBxC,EAAE,wBAAwBmB,IAAI,CAC1BsB,UAAW,OACXR,OAAQ,UACRX,QAAS,UACTS,aAAc,MACdL,QAAS,OACTE,WAAY,SACZC,IAAK,QAGT7B,EAAE,kBAAkBmB,IAAI,CACpBqB,WAAY,OACZE,YAAa,MACbC,WAAY,uBAGhB3C,EAAE,kBAAkBmB,IAAI,CACpBO,QAAS,OACTE,WAAY,SACZC,IAAK,MACLP,QAAS,UACTS,aAAc,MACdE,OAAQ,YAGZjC,EAAE,mCAAmCmB,IAAI,CACrCe,YAAa,YAIjBlC,EAAE,YAAYmB,IAAI,CACdyB,cAAe,SACfhB,WAAY,aACZN,QAAS,UACTS,aAAc,MACdV,WAAY,YAGhBrB,EAAE,kBAAkBmB,IAAI,CACpBmB,WAAY,IACZR,SAAU,SACVL,aAAc,QAGlBzB,EAAE,gBAAgBmB,IAAI,CAClBW,SAAU,UACVS,MAAO,mBAMNM,iBACD7C,EAAE,aAAakB,cAiFnBlB,EAAE,qBAAqB8C,+1GAGlB9C,EAAE,oBAAoBkB,QACvBlB,EAAE,qBAAqB+C,4JAQ3B/B,uCAyRMgC,UAAYhD,EAAE,qBAGpBgD,UAAUC,GAAG,aAAa,iBAChBC,KAAOlD,EAAE,oBACVkD,KAAKhC,SAENiC,KAAKC,UAAY,IACjBF,KAAKG,OAAO,KAEZH,KAAKI,QAAQ,SAKrBN,UAAUC,GAAG,WAAY,oBAAoB,WACzCD,UAAUO,QAAQ,CAAEH,UAAW,GAAK,QAGxCpD,EAAE,qBAAqBiD,GAAG,UAAU,iBAC1BO,IAAMxD,EAAEmD,MAAMM,MACpBxD,iBAAmBuD,IAAME,SAASF,IAAK,IAAM,cAjQzBG,cACnBA,gBACD3D,EAAE,kBAAkB4D,QACpBpD,aAAe,GACfC,gBAAkB,GAClBT,EAAE,yBAAyB6D,KAAK,WAAW,QAC3CC,sBAIJ9D,EAAE+D,KAAK,CACHC,IAAKC,EAAEC,IAAIC,QAAU,gCACrBC,OAAQ,OACRC,KAAMC,KAAKC,UAAU,CACjBC,OAAQ,cACRb,SAAUA,SACVc,QAASR,EAAEC,IAAIO,UAEnBC,YAAa,mBACbC,SAAU,OACVC,QAAS,SAASC,SACTA,MAAQA,IAAID,eACbE,QAAQC,MAAM,wBAAyBF,KACvC7E,EAAE,kBAAkBgF,KAAK,8DACzBxE,aAAe,GACfC,gBAAkB,QAClBqD,gCAiBQmB,aACpBzE,aAAe,GACfC,gBAAkB,GAClBT,EAAE,yBAAyB6D,KAAK,WAAW,IAEtCoB,SAAS/D,cACVlB,EAAE,kBAAkBgF,KAAK,2FACzBlB,0BAIAkB,KAAO,GAEXC,SAASC,SAAQC,gBACPC,MAAQxE,WAAWuE,QAAQE,MAAQ,SACnCC,MAAQC,MAAMC,QAAQL,QAAQG,OAASH,QAAQG,MAAQ,OAExDA,MAAMpE,oBAILuE,kBA0BcN,QAASG,aAC3BI,KAAO,CACTC,KAAM,OACNN,KAAMF,QAAQE,MAAQ,UACtBO,SAAU,WAGdN,MAAMJ,SAAQW,aACJC,OAASD,KAAKC,OACdT,KAAOQ,KAAKR,KACZU,KAAOF,KAAKE,MAAQV,KAE1B7E,aAAasF,QAAU,CACnBT,KAAMA,KACNU,KAAMA,KACNC,YAAab,QAAQE,MAAQ,GAC7B1B,SAAUwB,QAAQxB,UAAY1D,wBAG5BgG,MAAQF,KAAKG,MAAM,KAAKC,OAAOC,aACjCC,KAAOX,SAEN,IAAIY,EAAI,EAAGA,EAAIL,MAAM/E,OAAS,EAAGoF,IAAK,OACjCC,WAAaN,MAAMK,GACpBD,KAAKT,SAASW,cACfF,KAAKT,SAASW,YAAc,CACxBZ,KAAM,SACNN,KAAMkB,WACNX,SAAU,KAGlBS,KAAOA,KAAKT,SAASW,kBAGnBC,SAAWP,MAAMA,MAAM/E,OAAS,IAAMmE,KACtCoB,IAAMD,SAAW,KAAOV,OAE9BO,KAAKT,SAASa,KAAO,CACjBd,KAAM,OACNN,KAAMmB,SACNV,OAAQA,WAITJ,KAtEcgB,CAAmBvB,QAASG,OAE7CN,iNAIcI,0HAGAuB,eAAelB,mFAM5BT,OACDA,KAAO,sFAGXhF,EAAE,kBAAkBgF,KAAKA,MAGzBhE,sBACA8C,sBA1DQ8C,CAAe/B,IAAII,UAAY,KAEnCF,MAAO,SAAS8B,KACZ/B,QAAQC,MAAM,6BAA8B8B,KAC5C7G,EAAE,kBAAkBgF,KAAK,oDACzBxE,aAAe,GACfC,gBAAkB,GAClBqD,yBA8NJgD,CAAmB7G,kBACnB6D,yBAGJ9D,EAAE,yBAAyBiD,GAAG,UAAU,iBAC9B8D,QAAU/G,EAAEmD,MAAM6D,GAAG,YAC3BhH,EAAE,qBAAqB6D,KAAK,UAAWkD,SACvCE,yBACAnD,yBAGJ9D,EAAE,0BAA0BiD,GAAG,UAAU,iBAC/BQ,IAAMzD,EAAEmD,MAAMM,MACR,OAARA,KACAzD,EAAE,iBAAiBkH,OACnBlH,EAAE,kBAAkBmH,QACL,QAAR1D,KACPzD,EAAE,iBAAiBmH,OACnBnH,EAAE,kBAAkBkH,SAEpBlH,EAAE,iBAAiBmH,OACnBnH,EAAE,kBAAkBmH,QAExBrD,yBAGJ9D,EAAE,6CAA6CiD,GAAG,SAAS,WACvDa,yBAGJ9D,EAAE,qBAAqBiD,GAAG,SAAU,qBAAqB,WACrDgE,+BACMG,WAAapH,EAAE,qBAAqBkB,OACpCmG,cAAgBrH,EAAE,6BAA6BkB,OACrDlB,EAAE,yBAAyB6D,KAAK,UAAWuD,WAAa,GAAKA,aAAeC,eAC5EvD,yBAGJ9D,EAAE,qBACGiD,GAAG,QAAS,oBAAoB,iBACvBe,IAAMhE,EAAEmD,MAAMkB,KAAK,eACrBL,KACAsD,OAAOC,KAAKvD,IAAK,aAGxBf,GAAG,QAAS,kBAAkB,iBACrBuE,KAAOxH,EAAEmD,MACT2C,OAAS0B,KAAKnD,KAAK,UACnBV,SAAW6D,KAAKnD,KAAK,YACrBoD,MAAQD,KAAKnD,KAAK,iBAAmBnE,cAAgB,KAEtD4F,QAAWnC,WAAY6D,KAAK3D,KAAK,cAItC2D,KAAK3D,KAAK,YAAY,GAAM6D,KAAK,gBAEjC1H,EAAE+D,KAAK,CACHC,IAAKC,EAAEC,IAAIC,QAAU,gCACrBC,OAAQ,OACRC,KAAMC,KAAKC,UAAU,CACjBC,OAAQ,YACRsB,OAAQA,OACRnC,SAAUA,SACVgE,aAAcF,MACdhD,QAASR,EAAEC,IAAIO,UAEnBC,YAAa,mBACbC,SAAU,OACVC,QAAS,SAASC,KACVA,KAAOA,IAAID,QACX4C,KAAKE,KAAK,aAEVF,KAAK3D,KAAK,YAAY,GAAO6D,KAAK,iBAClC5C,QAAQC,MAAM,mBAAoBF,OAG1CE,MAAO,SAAS8B,KACZW,KAAK3D,KAAK,YAAY,GAAO6D,KAAK,iBAClC5C,QAAQC,MAAM,wBAAyB8B,KACvCe,MAAM,0CA7XtBC,GACA/D,sBAOA9D,EAAE+D,KAAK,CACHC,IAAKC,EAAEC,IAAIC,QAAU,gCACrBC,OAAQ,OACRC,KAAMC,KAAKC,UAAU,CACjBC,OAAQ,gBACRC,QAASR,EAAEC,IAAIO,UAEnBC,YAAa,mBACbC,SAAU,OACVC,QAAS,SAASC,KACTA,KAAQA,IAAID,iBAYCkD,eACpBC,QAAU/H,EAAE,qBAClB+H,QAAQnE,QACRmE,QAAQhF,OAAO,8CAEf+E,QAAQ5C,SAAQ8C,UACNC,MAAQrH,WAAWoH,EAAEE,UAAYF,EAAEG,WAAc,UAAYH,EAAEI,IACrEL,QAAQhF,gCACcjC,OAAOkH,EAAEI,iBAAQH,uBAhBnCI,CAAqBxD,IAAIiD,SAAW,IAHhChD,QAAQC,MAAM,0BAA2BF,MAKjDE,MAAO,SAAS8B,KACZ/B,QAAQC,MAAM,+BAAgC8B,iBA2JjDF,eAAeN,UACfA,OAASA,KAAKT,eACR,SAGL0C,KAAOC,OAAOD,KAAKjC,KAAKT,cACzB0C,KAAKpH,aACC,OAGP8D,KAAO,qCAEXsD,KAAKpD,SAAQuB,YACH+B,MAAQnC,KAAKT,SAASa,QACT,WAAf+B,MAAM7C,KACNX,8MAIcpE,WAAW4H,MAAMnD,+EAErBsB,eAAe6B,kEAGtB,GAAmB,SAAfA,MAAM7C,KAAiB,OACxB8C,IAAM3H,OAAO0H,MAAM1C,QACnB4C,MAAQ9H,WAAW4H,MAAMnD,MAC/BL,uLAG2EyD,yHAE7DC,8FAOtB1D,MAAQ,SACDA,cAGFiC,yBACLxG,gBAAkB,GAClBT,EAAE,6BAA6B2I,MAAK,iBAC1BF,IAAMzI,EAAEmD,MAAMkB,KAAK,UACrBoE,MAAAA,KACAhI,gBAAgBmI,KAAK9H,OAAO2H,kBAO/B3E,4BACC+E,YAAc7I,EAAE,qBAAqByD,MAC3CxD,iBAAmB4I,YAAcnF,SAASmF,YAAa,IAAM,KAE7D1I,OAAOC,SAAasD,SAAS1D,EAAE,YAAYyD,OAAS,IAAK,IACzDtD,OAAOE,SAAaqD,SAAS1D,EAAE,YAAYyD,OAAS,IAAK,IACzDtD,OAAOG,UAAaoD,SAAS1D,EAAE,aAAayD,OAAS,IAAK,IAC1DtD,OAAOI,WAAamD,SAAS1D,EAAE,cAAcyD,OAAS,IAAK,UAErDgE,MAAQzH,EAAE,kCAAkCyD,MAClDvD,aAAeuH,OAAS,SAEpBqB,SAAU,QACRC,YAAc9I,iBACd+I,SAAWvI,gBAAgBS,OAAS,MACtC+H,WAAY,EAEK,OAAjB/I,cACwB,IAApBC,OAAOC,UAAsC,IAApBD,OAAOE,WAChCF,OAAOC,SAAW,EAClBD,OAAOE,SAAW,EAClBL,EAAE,YAAYyD,IAAI,GAClBzD,EAAE,YAAYyD,IAAI,IAEtBwF,UAAa9I,OAAOC,SAAW,GAAKD,OAAOE,SAAW,GAC9B,QAAjBH,eACkB,IAArBC,OAAOG,WAAyC,IAAtBH,OAAOI,aACjCJ,OAAOG,UAAY,EACnBH,OAAOI,WAAa,EACpBP,EAAE,aAAayD,IAAI,GACnBzD,EAAE,cAAcyD,IAAI,IAExBwF,UAAa9I,OAAOG,UAAY,GAAKH,OAAOI,WAAa,GAG7DuI,QAAUC,WAAaC,YAAc9I,cAAgB+I,UAErDjJ,EAAE,kBAAkB6D,KAAK,YAAaiF,SACtC9I,EAAE,qBAAqB6D,KAAK,YAAaiF,eA+PtC,CACHI,oBA7wBgBxB,aAETA,MA4wBPyB,wBAzwBoBtE,IAAKuE,WAElB,GAwwBPC,iBAtyBApJ,iBAAmB,KACnBC,aAAe,KAEfC,OAAS,CACLC,SAAU,EACVC,SAAU,EACVC,UAAW,EACXC,WAAY,GAGhBC,aAAe,GACfC,gBAAkB,GAClBC,UAAW,EACXC,WAAa,KAEbX,EAAE,aAAasJ,SACftJ,EAAE,oBAAoBsJ,SACtBtJ,EAAE,qBAAqBuJ,IAAI,OAE3BvJ,EAAE,kBAAkB6D,KAAK,YAAY,GACrC7D,EAAE,qBAAqB6D,KAAK,YAAY,GAAO6D,KAAK,SAmxBpD8B,2BA9IA3G,cACA7C,EAAE,qBAAqB0H,KAAK,YAC5BhH,UAAW,EACXoD,uBA4IA2F,kBAvIcC,aAAcN,OAC5BtF,uBAEK7D,6BACDmJ,GAAGO,cAAc,mCAAoC,WAGpDzJ,yBACDkJ,GAAGO,cAAc,6CAA8C,WAG9DlJ,gBAAgBS,mBACjBkI,GAAGO,cAAc,sCAAuC,WAIxDV,WAAY,KACK,OAAjB/I,aACA+I,UAAa9I,OAAOC,SAAW,GAAKD,OAAOE,SAAW,EAC9B,QAAjBH,eACP+I,UAAa9I,OAAOG,UAAY,GAAKH,OAAOI,WAAa,IAExD0I,sBACDG,GAAGO,cAAc,6CAA8C,OAInE3J,EAAE,qBAAqB6D,KAAK,YAAY,GACxC7D,EAAE,yBAAyB6D,KAAK,YAAY,GAC5C7D,EAAE,0BAA0B6D,KAAK,YAAY,GAC7C7D,EAAE,6CAA6C6D,KAAK,YAAY,GAChE7D,EAAE,kBAAkB6D,KAAK,YAAY,GACrC7D,EAAE,qBAAqB6D,KAAK,YAAY,SAElC+F,SAAWF,cAAgB,IAAIG,OACjCnJ,UAAYC,YAAciJ,QAAQ1I,OAAS,EAC3CkI,GAAGO,cAAc,+BAAgC,OACzCjJ,SAGR0I,GAAGO,cAAc,kCAAmC,OAFpDP,GAAGO,cAAc,8BAA+B,aAK9CG,QAAU,CACZnG,SAAU1D,iBACV8J,cAAetJ,gBACfuJ,SAAUxJ,aACVmH,aAAczH,aACdC,OAAQA,OACRuJ,aAAcA,cAAgB,GAC9BjF,QAASR,EAAEC,IAAIO,SAGf/D,UAAYC,YACZmJ,QAAQG,KAAO,OACfH,QAAQI,SAAWvJ,YAEnBmJ,QAAQG,KAAO,UAGnBjK,EAAE+D,KAAK,CACHC,IAAKC,EAAEC,IAAIC,QAAU,gCACrBC,OAAQ,OACRC,KAAMC,KAAKC,UAAUuF,SACrBpF,YAAa,mBACbC,SAAU,OACVC,QAAS,SAASC,QACdC,QAAQqF,IAAI,oBAAqBtF,KAE7BA,KAAOA,IAAID,QAAS,OACdwF,YAAcvF,IAAIuF,aAAe,IACjCtE,OAASjB,IAAIiB,QAAU,EACvBnC,SAAWkB,IAAIlB,UAAY1D,iBAEjCU,WAAakE,IAAIR,MAAQQ,IAAIwF,WAAa,KAC1C3J,UAAW,QAELsE,qKAGIH,IAAIyF,QAAU1J,WAAWiE,IAAIyF,SAAW,OAAS,+FACE1J,WAAWwJ,6NAIzCxJ,WAAWE,OAAOgF,0EAChBlF,WAAWE,OAAO6C,gFACd/C,WAAWE,OAAOZ,cAAgB,yaAUvEkJ,GAAGO,cAAc3E,KAAM,YAEvBoE,GAAGO,cACC,YAAc/I,WAAWiE,KAAOA,IAAIE,MAAQF,IAAIE,MAAQ,iBACxD,OAIR/E,EAAE,qBAAqB6D,KAAK,YAAY,GACxC7D,EAAE,yBAAyB6D,KAAK,YAAY,GAC5C7D,EAAE,0BAA0B6D,KAAK,YAAY,GAC7C7D,EAAE,6CAA6C6D,KAAK,YAAY,GAChE7D,EAAE,kBAAkB6D,KAAK,YAAY,GACrC7D,EAAE,qBAAqB6D,KAAK,YAAY,IAE5CkB,MAAO,SAAS8B,KACZ/B,QAAQC,MAAM,iBAAkB8B,SAC5B0D,IAAM,qDACN1D,IAAI2D,cAAgB3D,IAAI2D,aAAazF,QACrCwF,IAAM1D,IAAI2D,aAAazF,OAE3BqE,GAAGO,cAAc,KAAOY,IAAK,OAE7BvK,EAAE,qBAAqB6D,KAAK,YAAY,GACxC7D,EAAE,yBAAyB6D,KAAK,YAAY,GAC5C7D,EAAE,0BAA0B6D,KAAK,YAAY,GAC7C7D,EAAE,6CAA6C6D,KAAK,YAAY,GAChE7D,EAAE,kBAAkB6D,KAAK,YAAY,GACrC7D,EAAE,qBAAqB6D,KAAK,YAAY"}