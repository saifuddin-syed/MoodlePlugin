define("local_automation/chatbot",["jquery","core/templates","local_automation/chat_assistant","local_automation/chat_qb","local_automation/chat_quiz"],(function($,Templates,Assistant,QB,Quiz){let currentMode="assistant";const handlers={assistant:Assistant,qb:QB,quiz:Quiz};function getStorageKey(){return"ai_chat_history_"+currentMode}function loadHistory(){$("#chatbot-messages").empty();let history=localStorage.getItem(getStorageKey());history&&(history=JSON.parse(history),history.forEach((msg=>appendMessage(msg.text,msg.sender,!1))),scrollMessagesToBottom())}function saveMessage(text,sender){let history=localStorage.getItem(getStorageKey());history=history?JSON.parse(history):[],history.push({text:text,sender:sender}),localStorage.setItem(getStorageKey(),JSON.stringify(history))}function appendMessage(text,sender){let store=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];const className="user"===sender?"msg-user":"msg-bot";$("#chatbot-messages").append('<div class="message '.concat(className,'">').concat(text,"</div>")),store&&saveMessage(text,sender),scrollMessagesToBottom()}function scrollMessagesToBottom(){const msgBox=$("#chatbot-messages")[0];msgBox&&msgBox.scrollTo({top:msgBox.scrollHeight,behavior:"smooth"})}function escapeHtml(str){return null==str?"":String(str).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}function showConfirmButton(onConfirm){$("#chatbot-action-area").html('\n            <div id="chatbot-edit-note">Type for any edits...</div>\n            <button id="chatbot-confirm-btn">Confirm</button>\n        '),$("#chatbot-confirm-btn").off("click").on("click",onConfirm)}function clearConfirmButton(){$("#chatbot-action-area").empty()}function handleSend(){const input=$("#chatbot-input"),text=input.val().trim();if("qb"===currentMode&&handlers.qb&&"function"==typeof handlers.qb.generate){const instructions=text;return instructions&&appendMessage(escapeHtml(instructions),"user"),input.val(""),void handlers.qb.generate(text,{appendMessage:appendMessage,scrollMessagesToBottom:scrollMessagesToBottom,showConfirmButton:showConfirmButton,clearConfirmButton:clearConfirmButton,escapeHtml:escapeHtml})}if(!text)return;appendMessage(escapeHtml(text),"user"),input.val("");let promptToSend=text;const handler=handlers[currentMode];handler&&"function"==typeof handler.beforeSend&&(promptToSend=handler.beforeSend(text)),$.ajax({url:M.cfg.wwwroot+"/local/automation/chatbot_endpoint.php",method:"POST",data:{prompt:promptToSend,mode:currentMode,sesskey:M.cfg.sesskey},success:function(res){const handler=handlers[currentMode];if(handler&&"function"==typeof handler.handleResponse){if(handler.handleResponse(res,{appendMessage:appendMessage,scrollMessagesToBottom:scrollMessagesToBottom,showConfirmButton:showConfirmButton,clearConfirmButton:clearConfirmButton,escapeHtml:escapeHtml}))return}if(res.reply){appendMessage(res.reply.replace(/\n/g,"<br>"),"bot")}else appendMessage("⚠️ "+(res.error||"No response from AI"),"bot")},error:function(xhr){appendMessage("❌ Failed to connect to server.","bot"),console.error(xhr)}})}function bindEvents(){$("#ai-chatbot-button").on("click",(()=>{$("#ai-chatbot-modal").toggleClass("hidden"),$("#chatbot-input").focus()})),$("#chatbot-close-btn").on("click",(()=>{$("#ai-chatbot-modal").addClass("hidden")})),$("#chatbot-send-btn").on("click",handleSend);$("#chatbot-input").on("input",(function(){this.style.height="auto",this.style.height=Math.min(this.scrollHeight,150)+"px"})),$("#chatbot-input").on("keypress",(function(e){"Enter"===e.key&&(e.preventDefault(),handleSend())})),$(".chat-tab").on("click",(function(){!function(newMode){if(newMode===currentMode)return;const oldHandler=handlers[currentMode];oldHandler&&"function"==typeof oldHandler.reset&&oldHandler.reset(),currentMode=newMode,console.log("Switched to mode: ".concat(currentMode)),$(".chat-tab").removeClass("active"),$('.chat-tab[data-mode="'.concat(currentMode,'"]')).addClass("active");const headerText={assistant:"AI Assistant",qb:"QB Generator",quiz:"Quiz Generator"}[currentMode];$(".chat-header span").text(headerText);const $input=$("#chatbot-input");"qb"===currentMode?$input.attr("placeholder","Type preferences for this question bank (optional)…"):"quiz"===currentMode?$input.attr("placeholder","Describe the quiz you want to generate…"):$input.attr("placeholder","Type your message…"),clearConfirmButton(),loadHistory();const handler=handlers[currentMode];handler&&"function"==typeof handler.onModeActivated&&handler.onModeActivated()}($(this).data("mode"))}))}return{init:function(){document.getElementById("chatbot-style")||$("head").append('<link id="chatbot-style" rel="stylesheet" href="'+M.cfg.wwwroot+'/local/automation/style/chatbot.css">'),Templates.render("local_automation/chatbot",{}).then((html=>{$("body").append(html);$("#ai-chatbot-modal").css({width:"720px",maxWidth:"90vw",height:"80vh",maxHeight:"80vh"}),$("#chatbot-messages").css({fontSize:"0.85rem",lineHeight:"1.4"}),$("#chatbot-messages .message").css({fontSize:"0.85rem",lineHeight:"1.5",padding:"6px 10px"}),$("#chatbot-input").css({fontSize:"0.85rem",minHeight:"40px",maxHeight:"150px",resize:"none"}),bindEvents(),loadHistory()})).catch((err=>console.error("Chatbot template load failed:",err)))}}}));

//# sourceMappingURL=chatbot.min.js.map