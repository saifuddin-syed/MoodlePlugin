define("local_automation/chatbot",["jquery","core/templates","local_automation/chat_assistant","local_automation/chat_qb","local_automation/chat_quiz","local_automation/chat_student"],(function($,Templates,Assistant,QB,Quiz,Student){let currentMode="assistant",pageConfig={};const handlers={assistant:Assistant,qb:QB,quiz:Quiz,student:Student,analytics:{}};function getStorageKey(){return"ai_chat_history_"+currentMode}function loadHistory(){$("#chatbot-messages").empty();let history=localStorage.getItem(getStorageKey());history&&(history=JSON.parse(history),history.forEach((msg=>appendMessage(msg.text,msg.sender,!1))),scrollMessagesToBottom())}function appendMessage(text,sender,timestamp){console.log("APPEND CALLED →",{text:text,sender:sender,timestamp:timestamp,type:typeof timestamp}),timestamp||console.warn("⚠️ TIMESTAMP IS INVALID:",timestamp);const dateObj=new Date(1e3*parseInt(timestamp)),time=dateObj.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),dateString=dateObj.toDateString(),container=$("#chatbot-messages"),lastDate=container.data("last-date");lastDate!==dateString&&(container.append('\n                <div class="chat-date-separator">\n                    '.concat(dateString,"\n                </div>\n            ")),container.data("last-date",dateString));const className="user"===sender?"msg-user":"msg-bot",messageHtml='\n            <div class="message '.concat(className,'">\n                <div class="message-text">').concat(text,'</div>\n                <div class="message-time">').concat(time,"</div>\n            </div>\n        ");container.append(messageHtml),scrollMessagesToBottom()}function scrollMessagesToBottom(){const msgBox=$("#chatbot-messages")[0];msgBox&&msgBox.scrollTo({top:msgBox.scrollHeight,behavior:"smooth"})}function escapeHtml(str){return null==str?"":String(str).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}function showConfirmButton(onConfirm){$("#chatbot-action-area").html('\n            <div id="chatbot-edit-note">Type for any edits...</div>\n            <button id="chatbot-confirm-btn">Confirm</button>\n        '),$("#chatbot-confirm-btn").off("click").on("click",onConfirm)}function clearConfirmButton(){$("#chatbot-action-area").empty()}function handleSend(){const input=$("#chatbot-input"),text=input.val().trim();if("student"===currentMode){if(!text)return;return input.val(""),void Student.saveMessageToDB(text,"user").then((function(res){"string"==typeof res&&(res=JSON.parse(res)),appendMessage(escapeHtml(text),"user",parseInt(res.timecreated),!1),Student.askRAG(text).then((function(res){if(res&&res.ok&&res.answer){const reply=res.answer.replace(/\n/g,"<br>");Student.saveMessageToDB(res.answer,"bot").then((function(botRes){"string"==typeof botRes&&(botRes=JSON.parse(botRes)),appendMessage(reply,"bot",parseInt(botRes.timecreated),!1)}))}else appendMessage("⚠️ Tutor failed to respond.","bot",!1)})).catch((function(err){console.error(err),appendMessage("❌ AI service unavailable.","bot",!1)}))}))}if("qb"===currentMode&&handlers.qb&&"function"==typeof handlers.qb.generate){const instructions=text;return instructions&&appendMessage(escapeHtml(instructions),"user"),input.val(""),void handlers.qb.generate(text,{appendMessage:appendMessage,scrollMessagesToBottom:scrollMessagesToBottom,showConfirmButton:showConfirmButton,clearConfirmButton:clearConfirmButton,escapeHtml:escapeHtml})}if("quiz"===currentMode&&handlers.quiz&&"function"==typeof handlers.quiz.generate){const instructions=text;return instructions&&appendMessage(escapeHtml(instructions),"user"),input.val(""),void handlers.quiz.generate(text,{appendMessage:appendMessage,scrollMessagesToBottom:scrollMessagesToBottom,showConfirmButton:showConfirmButton,clearConfirmButton:clearConfirmButton,escapeHtml:escapeHtml})}if(!text)return;appendMessage(escapeHtml(text),"user"),input.val("");let promptToSend=text;const handler=handlers[currentMode];handler&&"function"==typeof handler.beforeSend&&(promptToSend=handler.beforeSend(text)),$.ajax({url:M.cfg.wwwroot+"/local/automation/chatbot_endpoint.php",method:"POST",data:{prompt:promptToSend,mode:currentMode,sesskey:M.cfg.sesskey},success:function(res){const handler=handlers[currentMode];if(handler&&"function"==typeof handler.handleResponse){if(handler.handleResponse(res,{appendMessage:appendMessage,scrollMessagesToBottom:scrollMessagesToBottom,showConfirmButton:showConfirmButton,clearConfirmButton:clearConfirmButton,escapeHtml:escapeHtml}))return}if(res.reply){appendMessage(res.reply.replace(/\n/g,"<br>"),"bot")}else appendMessage("⚠️ "+(res.error||"No response from AI"),"bot")},error:function(xhr){appendMessage("❌ Failed to connect to server.","bot"),console.error(xhr)}})}function loadStudentDetails(studentid){$("#chatbot-messages").html("<div>Loading details...</div>"),$.ajax({url:M.cfg.wwwroot+"/local/automation/analytics_ajax.php",method:"POST",data:{action:"get_student_quiz",studentid:studentid,courseid:pageConfig.currentcourseid,sesskey:M.cfg.sesskey},success:function(quizzes){let html="<h4>Quiz Attempts</h4>";0===quizzes.length?html+="<div>No quiz attempts found.</div>":quizzes.forEach((q=>{html+="\n                            <div>\n                                Score: ".concat(q.score,"/").concat(q.total,"\n                                | Difficulty: ").concat(q.difficulty,"\n                                | Topic: ").concat(q.topic,"\n                            </div>\n                        ")})),html+='\n                    <h4 style="margin-top:20px;">Chat History</h4>\n                    <div id="analytics-chat-history"\n                         style="max-height:200px; overflow-y:auto; border:1px solid #ccc; padding:10px;">\n                        Loading chat history...\n                    </div>\n                ',$("#chatbot-messages").html(html),function(studentid){$.ajax({url:M.cfg.wwwroot+"/local/automation/analytics_ajax.php",method:"POST",data:{action:"get_student_chat",studentid:studentid,courseid:pageConfig.currentcourseid,sesskey:M.cfg.sesskey},success:function(messages){let chatHtml="";0===messages.length?chatHtml="<div>No chat history found.</div>":messages.forEach((msg=>{const senderLabel="user"===msg.sender?"Student":"AI";chatHtml+='\n                            <div style="margin-bottom:8px;">\n                                <strong>'.concat(senderLabel,":</strong>\n                                ").concat(msg.message,"\n                            </div>\n                        ")})),$("#analytics-chat-history").html(chatHtml)}})}(studentid)}})}function bindEvents(){$("#ai-chatbot-button").off("click"),$("#chatbot-close-btn").off("click"),$("#chatbot-send-btn").off("click"),$("#chatbot-input").off("input keypress"),$(".chat-tab").off("click"),$("#ai-chatbot-button").on("click",(()=>{$("#ai-chatbot-modal").toggleClass("hidden"),$("#chatbot-input").focus()})),$("#chatbot-close-btn").on("click",(()=>{$("#ai-chatbot-modal").addClass("hidden")})),$("#chatbot-send-btn").on("click",handleSend);$("#chatbot-input").on("input",(function(){this.style.height="auto",this.style.height=Math.min(this.scrollHeight,150)+"px"})),$("#chatbot-input").on("keypress",(function(e){"Enter"===e.key&&(e.preventDefault(),handleSend())})),$(".chat-tab").on("click",(function(){!function(newMode){if(newMode===currentMode)return;console.log("TAB SWITCH TO:",newMode);const oldHandler=handlers[currentMode];oldHandler&&"function"==typeof oldHandler.reset&&oldHandler.reset(),currentMode=newMode,console.log("Switched to mode: ".concat(currentMode)),$(".chat-tab").removeClass("active"),$('.chat-tab[data-mode="'.concat(currentMode,'"]')).addClass("active");const headerText={assistant:"AI Assistant",qb:"QB Generator",quiz:"Quiz Generator"}[currentMode];$(".chat-header span").text(headerText);const $input=$("#chatbot-input");if("qb"===currentMode)$input.attr("placeholder","Type preferences for this question bank (optional)…");else if("quiz"===currentMode)$input.attr("placeholder","Describe the quiz you want to generate…");else{if("analytics"===currentMode)return $(".chat-input-area").hide(),$input.attr("placeholder",""),$("#chatbot-messages").html("<div>Loading students...</div>"),$.ajax({url:M.cfg.wwwroot+"/local/automation/analytics_ajax.php",method:"POST",data:{action:"get_students",courseid:pageConfig.currentcourseid,sesskey:M.cfg.sesskey},success:function(students){let html="<h4>Enrolled Students</h4>";students.forEach((s=>{const name=escapeHtml((s.firstname||"")+" "+(s.lastname||""));html+='\n                            <div class="analytics-student" data-studentid="'.concat(escapeHtml(String(s.id)),'">\n                                ').concat(name,"\n                            </div>\n                        ")})),$("#chatbot-messages").html(html),$("#chatbot-messages").off("click",".analytics-student"),$("#chatbot-messages").on("click",".analytics-student",(function(){loadStudentDetails($(this).data("studentid"))}))},error:function(xhr){$("#chatbot-messages").html("<div>Error fetching students.</div>")}}),void clearConfirmButton();$input.attr("placeholder","Type your message…")}clearConfirmButton(),loadHistory();const handler=handlers[currentMode];handler&&"function"==typeof handler.onModeActivated&&handler.onModeActivated()}($(this).data("mode"))}))}function setupUIAndActivate(){$("#ai-chatbot-modal").css({width:"720px",maxWidth:"90vw",height:"80vh",maxHeight:"80vh"}),$("#chatbot-messages").css({fontSize:"0.85rem",lineHeight:"1.4"}),$("#chatbot-messages .message").css({fontSize:"0.85rem",lineHeight:"1.5",padding:"6px 10px"}),$("#chatbot-input").css({fontSize:"0.85rem",minHeight:"40px",maxHeight:"150px",resize:"none"}),bindEvents()}function activateModeAfterRender(config){if(config&&"student"===config.role){if(console.log("INSIDE STUDENT BLOCK"),parseInt(config.currentcourseid)!==parseInt(config.democourseid))return void $("#ai-chatbot-button").off("click");currentMode="student",$(".chat-tabs").hide(),$(".chat-header span").text("AI Course Tutor"),$("#chatbot-input").attr("placeholder","Ask about this course…"),Student.initConfig(config),$("#chatbot-action-area").html('<button id="take-mini-quiz-btn">Take Mini Quiz</button>'),$("#take-mini-quiz-btn").off("click").on("click",(function(){window.location.href=M.cfg.wwwroot+"/local/automation/student_quiz.php?courseid="+config.currentcourseid})),Student.loadHistory(appendMessage)}else $(".chat-tabs").show(),$(".chat-header span").text("AI Assistant"),currentMode="assistant",loadHistory()}return{init:function(cfg){if("string"==typeof cfg){const democourseid=void 0!==arguments[2]?arguments[2]:"";cfg={role:cfg,currentcourseid:parseInt(void 0!==arguments[1]?arguments[1]:0)||0,democourseid:String(democourseid)},console.warn("chatbot.init() called in legacy form — normalized config:",cfg)}console.trace("INIT TRACE"),console.log("INIT CALLED WITH:",cfg),pageConfig=cfg||{};const config=pageConfig;console.log("CONFIG TYPE:",typeof config),console.log("CONFIG VALUE:",config),document.getElementById("ai-chatbot-modal")?(setupUIAndActivate(),activateModeAfterRender(config)):Templates.render("local_automation/chatbot",{}).then((html=>{$("body").append(html),setupUIAndActivate(),activateModeAfterRender(config)})).catch((err=>console.error("Chatbot template load failed:",err))),console.log("SESSKEY:",M.cfg.sesskey)}}}));

//# sourceMappingURL=chatbot.min.js.map