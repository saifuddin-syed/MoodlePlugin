{"version":3,"file":"chatbot.min.js","sources":["../src/chatbot.js"],"sourcesContent":["// amd/src/chatbot.js\r\ndefine([\r\n    'jquery',\r\n    'core/templates',\r\n    'local_automation/chat_assistant',\r\n    'local_automation/chat_qb',\r\n    'local_automation/chat_quiz',\r\n    'local_automation/chat_student'\r\n], function($, Templates, Assistant, QB, Quiz, Student) {\r\n    'use strict';\r\n\r\n    const STORAGE_PREFIX = 'ai_chat_history_';\r\n    let currentMode = 'assistant'; // Default mode\r\n\r\n    // Page-level config passed from PHP (accessible to all functions)\r\n    let pageConfig = {};\r\n\r\n    // Mode-specific handlers (only assistant for now)\r\n    const handlers = {\r\n    assistant: Assistant,\r\n    qb: QB,\r\n    quiz: Quiz,\r\n    student: Student,\r\n    analytics: {}\r\n    };\r\n\r\n    // ===== History helpers =====\r\n    function getStorageKey() {\r\n        return STORAGE_PREFIX + currentMode;\r\n    }\r\n\r\n    function loadHistory() {\r\n        $('#chatbot-messages').empty();\r\n\r\n        let history = localStorage.getItem(getStorageKey());\r\n        if (!history) {\r\n            return;\r\n        }\r\n        history = JSON.parse(history);\r\n\r\n        history.forEach(msg => appendMessage(msg.text, msg.sender, false));\r\n        scrollMessagesToBottom();\r\n    }\r\n\r\n    function saveMessage(text, sender) {\r\n        let history = localStorage.getItem(getStorageKey());\r\n        history = history ? JSON.parse(history) : [];\r\n        history.push({ text, sender });\r\n        localStorage.setItem(getStorageKey(), JSON.stringify(history));\r\n    }\r\n\r\n    // ===== UI helpers =====\r\n    function appendMessage(text, sender, timestamp, store = true) {\r\n\r\n            console.log(\"APPEND CALLED →\", {\r\n            text,\r\n            sender,\r\n            timestamp,\r\n            type: typeof timestamp\r\n        });\r\n\r\n        if (!timestamp) {\r\n            console.warn(\"⚠️ TIMESTAMP IS INVALID:\", timestamp);\r\n        }\r\n\r\n        const dateObj = new Date(parseInt(timestamp) * 1000);\r\n        const time = dateObj.toLocaleTimeString([], {\r\n            hour: '2-digit',\r\n            minute: '2-digit'\r\n        });\r\n\r\n        const dateString = dateObj.toDateString();\r\n    \r\n        const container = $('#chatbot-messages');\r\n    \r\n        const lastDate = container.data('last-date');\r\n    \r\n        // Add date separator if new day\r\n        if (lastDate !== dateString) {\r\n            container.append(`\r\n                <div class=\"chat-date-separator\">\r\n                    ${dateString}\r\n                </div>\r\n            `);\r\n            container.data('last-date', dateString);\r\n        }\r\n    \r\n        const className = sender === 'user' ? 'msg-user' : 'msg-bot';\r\n    \r\n        const messageHtml = `\r\n            <div class=\"message ${className}\">\r\n                <div class=\"message-text\">${text}</div>\r\n                <div class=\"message-time\">${time}</div>\r\n            </div>\r\n        `;\r\n    \r\n        container.append(messageHtml);\r\n    \r\n        scrollMessagesToBottom();\r\n    }\r\n\r\n    function scrollMessagesToBottom() {\r\n        const msgBox = $('#chatbot-messages')[0];\r\n        if (msgBox) {\r\n            msgBox.scrollTo({ top: msgBox.scrollHeight, behavior: 'smooth' });\r\n        }\r\n    }\r\n\r\n    // helper to escape HTML to avoid XSS with user-editable data\r\n    function escapeHtml(str) {\r\n        if (str === null || str === undefined) return '';\r\n        return String(str)\r\n            .replace(/&/g, '&amp;')\r\n            .replace(/</g, '&lt;')\r\n            .replace(/>/g, '&gt;')\r\n            .replace(/\"/g, '&quot;')\r\n            .replace(/'/g, '&#039;');\r\n    }\r\n\r\n    // ===== Confirm button area (used by assistant handler) =====\r\n    function showConfirmButton(onConfirm) {\r\n        const area = $('#chatbot-action-area');\r\n\r\n        area.html(`\r\n            <div id=\"chatbot-edit-note\">Type for any edits...</div>\r\n            <button id=\"chatbot-confirm-btn\">Confirm</button>\r\n        `);\r\n\r\n        $('#chatbot-confirm-btn').off('click').on('click', onConfirm);\r\n    }\r\n\r\n    function clearConfirmButton() {\r\n        $('#chatbot-action-area').empty();\r\n    }\r\n\r\n    // ===== Core send logic =====\r\n    function handleSend() {\r\n        const input = $('#chatbot-input');\r\n        const text = input.val().trim();\r\n\r\n        if (currentMode === 'student') {\r\n            if (!text) return;\r\n\r\n            // appendMessage(escapeHtml(text), 'user', false);\r\n            input.val('');\r\n\r\n            Student.saveMessageToDB(text, 'user').then(function(res) {\r\n                if (typeof res === 'string') {\r\n                    res = JSON.parse(res);\r\n                }\r\n            \r\n                appendMessage(escapeHtml(text), 'user', parseInt(res.timecreated), false);\r\n            \r\n                Student.askRAG(text).then(function(res) {\r\n                \r\n                    if (res && res.ok && res.answer) {\r\n                        const reply = res.answer.replace(/\\n/g, '<br>');\r\n                        // appendMessage(reply, 'bot', false);\r\n                        // Student.saveMessageToDB(res.answer, 'bot');\r\n                        Student.saveMessageToDB(res.answer, 'bot').then(function(botRes) {\r\n\r\n                            if (typeof botRes === 'string') {\r\n                                botRes = JSON.parse(botRes);\r\n                            }\r\n                        \r\n                            appendMessage(reply, 'bot', parseInt(botRes.timecreated), false);\r\n                        });\r\n                    } else {\r\n                        appendMessage('⚠️ Tutor failed to respond.', 'bot', false);\r\n                    }\r\n                \r\n                }).catch(function(err) {\r\n                    console.error(err);\r\n                    appendMessage('❌ AI service unavailable.', 'bot', false);\r\n                });\r\n            \r\n            });\r\n        \r\n            return;\r\n        }\r\n        \r\n        // QB mode uses its own endpoint (qb_ajax.php), not chatbot_endpoint.php\r\n        if (currentMode === 'qb' && handlers.qb && typeof handlers.qb.generate === 'function') {\r\n            const instructions = text; // can be empty string\r\n\r\n            // Only show a user bubble if they actually typed something\r\n            if (instructions) {\r\n                appendMessage(escapeHtml(instructions), 'user');\r\n            }\r\n        \r\n            input.val('');\r\n            handlers.qb.generate(text, {\r\n                appendMessage,\r\n                scrollMessagesToBottom,\r\n                showConfirmButton,   // not used by QB now, but available\r\n                clearConfirmButton,\r\n                escapeHtml\r\n            });\r\n            return;\r\n        }\r\n\r\n        if (currentMode === 'quiz' && handlers.quiz && typeof handlers.quiz.generate === 'function') {\r\n            const instructions = text;\r\n\r\n            if (instructions) {\r\n                appendMessage(escapeHtml(instructions), 'user');\r\n            }\r\n        \r\n            input.val('');\r\n            handlers.quiz.generate(text, {\r\n                appendMessage,\r\n                scrollMessagesToBottom,\r\n                showConfirmButton,\r\n                clearConfirmButton,\r\n                escapeHtml\r\n            });\r\n            return;\r\n        }\r\n\r\n        if (!text) {\r\n            return;\r\n        }\r\n\r\n        appendMessage(escapeHtml(text), 'user');\r\n        input.val('');\r\n\r\n        // Allow mode-specific handler to transform the prompt (e.g., assistant edit flow)\r\n        let promptToSend = text;\r\n        const handler = handlers[currentMode];\r\n        if (handler && typeof handler.beforeSend === 'function') {\r\n            promptToSend = handler.beforeSend(text);\r\n        }\r\n\r\n        $.ajax({\r\n            url: M.cfg.wwwroot + '/local/automation/chatbot_endpoint.php',\r\n            method: 'POST',\r\n            data: {\r\n                prompt: promptToSend,\r\n                mode: currentMode,\r\n                sesskey: M.cfg.sesskey\r\n            },\r\n            success: function(res) {\r\n                // Give mode handler a first chance to process structured automation responses\r\n                const handler = handlers[currentMode];\r\n                if (handler && typeof handler.handleResponse === 'function') {\r\n                    const consumed = handler.handleResponse(res, {\r\n                        appendMessage,\r\n                        scrollMessagesToBottom,\r\n                        showConfirmButton,\r\n                        clearConfirmButton,\r\n                        escapeHtml\r\n                    });\r\n\r\n                    if (consumed) {\r\n                        return;\r\n                    }\r\n                }\r\n\r\n                // Fallback plain-text handling (for qb / quiz / generic assistant replies)\r\n                if (res.reply) {\r\n                    const formattedReply = res.reply.replace(/\\n/g, '<br>');\r\n                    appendMessage(formattedReply, 'bot');\r\n                } else {\r\n                    appendMessage('⚠️ ' + (res.error || 'No response from AI'), 'bot');\r\n                }\r\n            },\r\n            error: function(xhr) {\r\n                appendMessage('❌ Failed to connect to server.', 'bot');\r\n                console.error(xhr);\r\n            }\r\n        });\r\n    }\r\n\r\n    //analytics helper\r\n    function loadStudentDetails(studentid) {\r\n        $('#chatbot-messages').html('<div>Loading details...</div>');\r\n\r\n        // First fetch quiz attempts\r\n        $.ajax({\r\n            url: M.cfg.wwwroot + '/local/automation/analytics_ajax.php',\r\n            method: 'POST',\r\n            data: {\r\n                action: 'get_student_quiz',\r\n                studentid: studentid,\r\n                courseid: pageConfig.currentcourseid,\r\n                sesskey: M.cfg.sesskey\r\n            },\r\n            success: function(quizzes) {\r\n\r\n                let html = '<h4>Quiz Attempts</h4>';\r\n\r\n                if (quizzes.length === 0) {\r\n                    html += '<div>No quiz attempts found.</div>';\r\n                } else {\r\n                    quizzes.forEach(q => {\r\n                        html += `\r\n                            <div>\r\n                                Score: ${q.score}/${q.total}\r\n                                | Difficulty: ${q.difficulty}\r\n                                | Topic: ${q.topic}\r\n                            </div>\r\n                        `;\r\n                    });\r\n                }\r\n\r\n                // Add Chat History section placeholder\r\n                html += `\r\n                    <h4 style=\"margin-top:20px;\">Chat History</h4>\r\n                    <div id=\"analytics-chat-history\"\r\n                         style=\"max-height:200px; overflow-y:auto; border:1px solid #ccc; padding:10px;\">\r\n                        Loading chat history...\r\n                    </div>\r\n                `;\r\n\r\n                $('#chatbot-messages').html(html);\r\n\r\n                // Now fetch chat history\r\n                fetchStudentChat(studentid);\r\n            }\r\n        });\r\n    }\r\n\r\n    function fetchStudentChat(studentid) {\r\n        $.ajax({\r\n            url: M.cfg.wwwroot + '/local/automation/analytics_ajax.php',\r\n            method: 'POST',\r\n            data: {\r\n                action: 'get_student_chat',\r\n                studentid: studentid,\r\n                courseid: pageConfig.currentcourseid,\r\n                sesskey: M.cfg.sesskey\r\n            },\r\n            success: function(messages) {\r\n\r\n                let chatHtml = '';\r\n\r\n                if (messages.length === 0) {\r\n                    chatHtml = '<div>No chat history found.</div>';\r\n                } else {\r\n                    messages.forEach(msg => {\r\n                        const senderLabel = msg.sender === 'user' ? 'Student' : 'AI';\r\n                        chatHtml += `\r\n                            <div style=\"margin-bottom:8px;\">\r\n                                <strong>${senderLabel}:</strong>\r\n                                ${msg.message}\r\n                            </div>\r\n                        `;\r\n                    });\r\n                }\r\n\r\n                $('#analytics-chat-history').html(chatHtml);\r\n            }\r\n        });\r\n    }\r\n\r\n    // ===== Tab switching =====\r\n    function handleTabSwitch(newMode) {\r\n        if (newMode === currentMode) {\r\n            return;\r\n        }\r\n        console.log(\"TAB SWITCH TO:\", newMode);\r\n\r\n        // Reset previous mode handler (if any state)\r\n        const oldHandler = handlers[currentMode];\r\n        if (oldHandler && typeof oldHandler.reset === 'function') {\r\n            oldHandler.reset();\r\n        }\r\n\r\n        currentMode = newMode;\r\n        console.log(`Switched to mode: ${currentMode}`);\r\n\r\n        // Update tab visuals\r\n        $('.chat-tab').removeClass('active');\r\n        $(`.chat-tab[data-mode=\"${currentMode}\"]`).addClass('active');\r\n\r\n        // Update header title\r\n        const headerText = {\r\n            assistant: 'AI Assistant',\r\n            qb: 'QB Generator',\r\n            quiz: 'Quiz Generator'\r\n        }[currentMode];\r\n        $('.chat-header span').text(headerText);\r\n\r\n        // Mode-specific placeholder\r\n        const $input = $('#chatbot-input');\r\n        if (currentMode === 'qb') {\r\n            $input.attr('placeholder', 'Type preferences for this question bank (optional)…');\r\n        } else if (currentMode === 'quiz') {\r\n            $input.attr('placeholder', 'Describe the quiz you want to generate…');\r\n        } else if (currentMode === 'analytics') {\r\n            // hide input area for analytics mode\r\n            const $inputArea = $('.chat-input-area');\r\n            $inputArea.hide();\r\n            $input.attr('placeholder', ''); // no placeholder\r\n\r\n            // Load analytics content\r\n            $('#chatbot-messages').html('<div>Loading students...</div>');\r\n\r\n            $.ajax({\r\n                url: M.cfg.wwwroot + '/local/automation/analytics_ajax.php',\r\n                method: 'POST',\r\n                data: {\r\n                    action: 'get_students',\r\n                    courseid: pageConfig.currentcourseid,\r\n                    sesskey: M.cfg.sesskey\r\n                },\r\n                success: function(students) {\r\n                    let html = '<h4>Enrolled Students</h4>';\r\n                    students.forEach(s => {\r\n                        const name = escapeHtml((s.firstname || '') + ' ' + (s.lastname || ''));\r\n                        html += `\r\n                            <div class=\"analytics-student\" data-studentid=\"${escapeHtml(String(s.id))}\">\r\n                                ${name}\r\n                            </div>\r\n                        `;\r\n                    });\r\n\r\n                    $('#chatbot-messages').html(html);\r\n\r\n                    // delegated click handler (safer)\r\n                    $('#chatbot-messages').off('click', '.analytics-student');\r\n                    $('#chatbot-messages').on('click', '.analytics-student', function() {\r\n                        const studentid = $(this).data('studentid');\r\n                        loadStudentDetails(studentid);\r\n                    });\r\n                },\r\n                error: function(xhr) {\r\n                    $('#chatbot-messages').html('<div>Error fetching students.</div>');\r\n                }\r\n            });\r\n\r\n            clearConfirmButton();\r\n            return;\r\n        } else {\r\n            // Assistant default\r\n            $input.attr('placeholder', 'Type your message…');\r\n        }\r\n\r\n        clearConfirmButton();\r\n        loadHistory();\r\n\r\n        const handler = handlers[currentMode];\r\n        if (handler && typeof handler.onModeActivated === 'function') {\r\n            handler.onModeActivated();\r\n        }\r\n    }\r\n\r\n    // ===== Event binding =====\r\n    function bindEvents() {\r\n        // Unbind first to avoid duplicate handlers if init runs twice\r\n        $('#ai-chatbot-button').off('click');\r\n        $('#chatbot-close-btn').off('click');\r\n        $('#chatbot-send-btn').off('click');\r\n        $('#chatbot-input').off('input keypress');\r\n        $('.chat-tab').off('click');\r\n\r\n        $('#ai-chatbot-button').on('click', () => {\r\n            $('#ai-chatbot-modal').toggleClass('hidden');\r\n            $('#chatbot-input').focus();\r\n        });\r\n\r\n        $('#chatbot-close-btn').on('click', () => {\r\n            $('#ai-chatbot-modal').addClass('hidden');\r\n        });\r\n\r\n        $('#chatbot-send-btn').on('click', handleSend);\r\n\r\n        // Auto-resize input like a chat textarea\r\n        const $input = $('#chatbot-input');\r\n        $input.on('input', function() {\r\n            const maxHeight = 150; // px – grows up to this height\r\n            this.style.height = 'auto';\r\n            this.style.height = Math.min(this.scrollHeight, maxHeight) + 'px';\r\n        });\r\n\r\n        $('#chatbot-input').on('keypress', function(e) {\r\n            if (e.key === 'Enter') {\r\n                e.preventDefault();\r\n                handleSend();\r\n            }\r\n        });\r\n\r\n        $('.chat-tab').on('click', function() {\r\n            const mode = $(this).data('mode');\r\n            handleTabSwitch(mode);\r\n        });\r\n    }\r\n\r\n    // Helper to set up the UI after template is present (idempotent)\r\n    function setupUIAndActivate() {\r\n        // ensure modal element exists; if not, render caller handles append\r\n        const $modal = $('#ai-chatbot-modal');\r\n        $modal.css({\r\n            width: '720px',\r\n            maxWidth: '90vw',\r\n            height: '80vh',\r\n            maxHeight: '80vh'\r\n        });\r\n\r\n        // Slightly smaller bubbles\r\n        $('#chatbot-messages').css({\r\n            fontSize: '0.85rem',\r\n            lineHeight: '1.4'\r\n        });\r\n        $('#chatbot-messages .message').css({\r\n            fontSize: '0.85rem',\r\n            lineHeight: '1.5',\r\n            padding: '6px 10px'\r\n        });\r\n        $('#chatbot-input').css({\r\n            fontSize: '0.85rem',\r\n            minHeight: '40px',\r\n            maxHeight: '150px',\r\n            resize: 'none'\r\n        });\r\n\r\n        bindEvents();\r\n    }\r\n\r\n    // ===== Init =====\r\n    function init(cfg) {\r\n        // Backwards-compat: if called as init(\"student\",\"21\",\"21\")\r\n        if (typeof cfg === 'string') {\r\n            // cfg is role string; build the config object from arguments\r\n            const role = cfg;\r\n            const currentcourseid = (typeof arguments[1] !== 'undefined') ? arguments[1] : 0;\r\n            const democourseid = (typeof arguments[2] !== 'undefined') ? arguments[2] : '';\r\n            cfg = {\r\n                role: role,\r\n                currentcourseid: parseInt(currentcourseid) || 0,\r\n                democourseid: String(democourseid)\r\n            };\r\n            console.warn('chatbot.init() called in legacy form — normalized config:', cfg);\r\n        }\r\n\r\n        console.trace('INIT TRACE');\r\n        console.log('INIT CALLED WITH:', cfg);\r\n\r\n        // Normalize and store page-level config (module scope)\r\n        pageConfig = cfg || {};\r\n        const config = pageConfig; // alias used inside init\r\n        console.log(\"CONFIG TYPE:\", typeof config);\r\n        console.log(\"CONFIG VALUE:\", config);\r\n\r\n        // only render template if it doesn't already exist\r\n        if (!document.getElementById('ai-chatbot-modal')) {\r\n            Templates.render('local_automation/chatbot', {})\r\n                .then(html => {\r\n                    $('body').append(html);\r\n                    setupUIAndActivate();\r\n                    activateModeAfterRender(config);\r\n                })\r\n                .catch(err => console.error('Chatbot template load failed:', err));\r\n        } else {\r\n            // already present in DOM — just set up UI and activate mode\r\n            setupUIAndActivate();\r\n            activateModeAfterRender(config);\r\n        }\r\n\r\n        console.log(\"SESSKEY:\", M.cfg.sesskey);\r\n    }\r\n\r\n    // helper to pick student/teacher flow after template present\r\n    function activateModeAfterRender(config) {\r\n        // For safety, ensure Student knows config\r\n        if (config && config.role === 'student') {\r\n            console.log(\"INSIDE STUDENT BLOCK\");\r\n\r\n            // If outside demo course → disable button\r\n            if (parseInt(config.currentcourseid) !== parseInt(config.democourseid)) {\r\n                $('#ai-chatbot-button').off('click');\r\n                return;\r\n            }\r\n\r\n            currentMode = 'student';\r\n            $('.chat-tabs').hide();\r\n            $('.chat-header span').text('AI Course Tutor');\r\n            $('#chatbot-input').attr('placeholder', 'Ask about this course…');\r\n\r\n            Student.initConfig(config);\r\n\r\n            // Make input area flex (ensures proper alignment)\r\n            $('.chat-input-area').css({\r\n                display: 'flex',\r\n                alignItems: 'center',\r\n                gap: '8px'\r\n            });\r\n\r\n            // Remove old action-area button\r\n            $('#chatbot-action-area').empty();\r\n\r\n            // Add Take Quiz icon button to LEFT of input\r\n            if (!$('#chatbot-take-quiz-btn').length) {\r\n                $('.chat-input-area').prepend(`\r\n                    <button id=\"chatbot-take-quiz-btn\"\r\n                            type=\"button\"\r\n                            title=\"Take Quiz\"\r\n                            aria-label=\"Take Quiz\">\r\n                        ✍️\r\n                    </button>\r\n                `);\r\n            }\r\n\r\n            // Keep SAME redirect logic as before\r\n            $('#chatbot-take-quiz-btn').off('click').on('click', function () {\r\n                window.location.href =\r\n                    M.cfg.wwwroot +\r\n                    '/local/automation/student_quiz.php?courseid=' +\r\n                    config.currentcourseid;\r\n            });\r\n\r\n            // Modify Send button styling + icon\r\n            $('#chatbot-send-btn')\r\n                .html('✉️')\r\n                .attr('title', 'Send Message')\r\n                .attr('aria-label', 'Send Message')\r\n                .css({\r\n                    borderRadius: '14px',\r\n                    padding: '6px 14px',\r\n                    fontSize: '18px'\r\n                });\r\n\r\n            Student.loadHistory(appendMessage);\r\n\r\n        } else {\r\n            // Teacher → use localStorage history\r\n            $('.chat-tabs').show();\r\n            $('.chat-header span').text('AI Assistant');\r\n            currentMode = 'assistant';\r\n            loadHistory();\r\n        }\r\n    }\r\n\r\n    return { init: init };\r\n});\r\n"],"names":["define","$","Templates","Assistant","QB","Quiz","Student","currentMode","pageConfig","handlers","assistant","qb","quiz","student","analytics","getStorageKey","loadHistory","empty","history","localStorage","getItem","JSON","parse","forEach","msg","appendMessage","text","sender","scrollMessagesToBottom","timestamp","console","log","type","warn","dateObj","Date","parseInt","time","toLocaleTimeString","hour","minute","dateString","toDateString","container","lastDate","data","append","className","messageHtml","msgBox","scrollTo","top","scrollHeight","behavior","escapeHtml","str","String","replace","showConfirmButton","onConfirm","html","off","on","clearConfirmButton","handleSend","input","val","trim","saveMessageToDB","then","res","timecreated","askRAG","ok","answer","reply","botRes","catch","err","error","generate","instructions","promptToSend","handler","beforeSend","ajax","url","M","cfg","wwwroot","method","prompt","mode","sesskey","success","handleResponse","xhr","loadStudentDetails","studentid","action","courseid","currentcourseid","quizzes","length","q","score","total","difficulty","topic","messages","chatHtml","senderLabel","message","fetchStudentChat","bindEvents","toggleClass","focus","addClass","style","height","Math","min","this","e","key","preventDefault","newMode","oldHandler","reset","removeClass","headerText","$input","attr","hide","students","s","name","firstname","lastname","id","onModeActivated","handleTabSwitch","setupUIAndActivate","css","width","maxWidth","maxHeight","fontSize","lineHeight","padding","minHeight","resize","activateModeAfterRender","config","role","democourseid","initConfig","display","alignItems","gap","prepend","window","location","href","borderRadius","show","init","arguments","trace","document","getElementById","render"],"mappings":"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"}