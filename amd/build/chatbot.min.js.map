{"version":3,"file":"chatbot.min.js","sources":["../src/chatbot.js"],"sourcesContent":["define(['jquery', 'core/templates'], function($, Templates) {\r\n    'use strict';\r\n\r\n    const STORAGE_PREFIX = 'ai_chat_history_';\r\n    let currentMode = 'assistant'; // Default mode\r\n\r\n    function getStorageKey() {\r\n        return STORAGE_PREFIX + currentMode;\r\n    }\r\n\r\n    function loadHistory() {\r\n        $('#chatbot-messages').empty();\r\n\r\n        let history = localStorage.getItem(getStorageKey());\r\n        if (!history) return;\r\n        history = JSON.parse(history);\r\n\r\n        history.forEach(msg => appendMessage(msg.text, msg.sender, false));\r\n        scrollMessagesToBottom();\r\n    }\r\n\r\n    function saveMessage(text, sender) {\r\n        let history = localStorage.getItem(getStorageKey());\r\n        history = history ? JSON.parse(history) : [];\r\n        history.push({ text, sender });\r\n        localStorage.setItem(getStorageKey(), JSON.stringify(history));\r\n    }\r\n\r\n    function appendMessage(text, sender, store = true) {\r\n        const className = sender === 'user' ? 'msg-user' : 'msg-bot';\r\n        $('#chatbot-messages').append(`<div class=\"message ${className}\">${text}</div>`);\r\n\r\n        if (store) saveMessage(text, sender);\r\n        scrollMessagesToBottom();\r\n    }\r\n\r\n    function scrollMessagesToBottom() {\r\n        const msgBox = $('#chatbot-messages')[0];\r\n        if (msgBox) {\r\n            msgBox.scrollTo({ top: msgBox.scrollHeight, behavior: 'smooth' });\r\n        }\r\n    }\r\n\r\n    // function handleSend() {\r\n    //     const input = $('#chatbot-input');\r\n    //     const text = input.val().trim();\r\n    //     if (!text) return;\r\n\r\n    //     appendMessage(text, 'user');\r\n    //     console.log(`[${currentMode}] User typed:`, text);\r\n    //     input.val('');\r\n\r\n    //     setTimeout(() => {\r\n    //         appendMessage(`Working in ${currentMode} mode ✅`, 'bot');\r\n    //     }, 600);\r\n    // }\r\n\r\n    function handleSend() {\r\n        const input = $('#chatbot-input');\r\n        const text = input.val().trim();\r\n        if (!text) return;\r\n\r\n        appendMessage(text, 'user');\r\n        input.val('');\r\n\r\n        $.ajax({\r\n            url: M.cfg.wwwroot + '/local/automation/chatbot_endpoint.php',\r\n            method: 'POST',\r\n            data: {\r\n                prompt: text,\r\n                mode: currentMode,\r\n                sesskey: M.cfg.sesskey\r\n            },\r\n            success: function(res) {\r\n                if (res.reply) {\r\n                    const formattedReply = res.reply.replace(/\\n/g, '<br>');\r\n                    appendMessage(formattedReply, 'bot');\r\n                } else {\r\n                    appendMessage('⚠️ ' + (res.error || 'No response from AI'), 'bot');\r\n                }\r\n            },\r\n            error: function(xhr) {\r\n                appendMessage('❌ Failed to connect to server.', 'bot');\r\n                console.error(xhr);\r\n            }\r\n        });\r\n    }\r\n\r\n\r\n    function handleTabSwitch(newMode) {\r\n        if (newMode === currentMode) return;\r\n\r\n        currentMode = newMode;\r\n        console.log(`Switched to mode: ${currentMode}`);\r\n\r\n        // Update tab visuals\r\n        $('.chat-tab').removeClass('active');\r\n        $(`.chat-tab[data-mode=\"${currentMode}\"]`).addClass('active');\r\n\r\n        // Update header title\r\n        const headerText = {\r\n            assistant: 'AI Assistant',\r\n            qb: 'QB Generator',\r\n            quiz: 'Quiz Generator'\r\n        }[currentMode];\r\n        $('.chat-header span').text(headerText);\r\n\r\n        loadHistory();\r\n    }\r\n\r\n    function bindEvents() {\r\n        $('#ai-chatbot-button').on('click', () => {\r\n            $('#ai-chatbot-modal').toggleClass('hidden');\r\n            $('#chatbot-input').focus();\r\n        });\r\n\r\n        $('#chatbot-close-btn').on('click', () => {\r\n            $('#ai-chatbot-modal').addClass('hidden');\r\n        });\r\n\r\n        $('#chatbot-send-btn').on('click', handleSend);\r\n\r\n        $('#chatbot-input').on('keypress', function(e) {\r\n            if (e.key === 'Enter') {\r\n                e.preventDefault();\r\n                handleSend();\r\n            }\r\n        });\r\n\r\n        $('.chat-tab').on('click', function() {\r\n            const mode = $(this).data('mode');\r\n            handleTabSwitch(mode);\r\n        });\r\n    }\r\n\r\n    function init() {\r\n        if (!document.getElementById('chatbot-style')) {\r\n            $('head').append('<link id=\"chatbot-style\" rel=\"stylesheet\" href=\"'+M.cfg.wwwroot+'/local/automation/style/chatbot.css\">');\r\n        }\r\n        \r\n        Templates.render('local_automation/chatbot', {})\r\n            .then(html => {\r\n                $('body').append(html);\r\n                bindEvents();\r\n                loadHistory();\r\n            })\r\n            .catch(err => console.error(\"Chatbot template load failed:\", err));\r\n    }\r\n\r\n    return { init: init };\r\n});\r\n"],"names":["define","$","Templates","currentMode","getStorageKey","loadHistory","empty","history","localStorage","getItem","JSON","parse","forEach","msg","appendMessage","text","sender","scrollMessagesToBottom","saveMessage","push","setItem","stringify","store","className","append","msgBox","scrollTo","top","scrollHeight","behavior","handleSend","input","val","trim","ajax","url","M","cfg","wwwroot","method","data","prompt","mode","sesskey","success","res","reply","replace","error","xhr","console","bindEvents","on","toggleClass","focus","addClass","e","key","preventDefault","newMode","log","removeClass","headerText","assistant","qb","quiz","handleTabSwitch","this","init","document","getElementById","render","then","html","catch","err"],"mappings":"AAAAA,kCAAO,CAAC,SAAU,mBAAmB,SAASC,EAAGC,eAIzCC,YAAc,qBAETC,sBAHc,mBAIKD,qBAGnBE,cACLJ,EAAE,qBAAqBK,YAEnBC,QAAUC,aAAaC,QAAQL,iBAC9BG,UACLA,QAAUG,KAAKC,MAAMJ,SAErBA,QAAQK,SAAQC,KAAOC,cAAcD,IAAIE,KAAMF,IAAIG,QAAQ,KAC3DC,mCAGKC,YAAYH,KAAMC,YACnBT,QAAUC,aAAaC,QAAQL,iBACnCG,QAAUA,QAAUG,KAAKC,MAAMJ,SAAW,GAC1CA,QAAQY,KAAK,CAAEJ,KAAAA,KAAMC,OAAAA,SACrBR,aAAaY,QAAQhB,gBAAiBM,KAAKW,UAAUd,mBAGhDO,cAAcC,KAAMC,YAAQM,uEAC3BC,UAAuB,SAAXP,OAAoB,WAAa,UACnDf,EAAE,qBAAqBuB,qCAA8BD,uBAAcR,gBAE/DO,OAAOJ,YAAYH,KAAMC,QAC7BC,kCAGKA,+BACCQ,OAASxB,EAAE,qBAAqB,GAClCwB,QACAA,OAAOC,SAAS,CAAEC,IAAKF,OAAOG,aAAcC,SAAU,oBAkBrDC,mBACCC,MAAQ9B,EAAE,kBACVc,KAAOgB,MAAMC,MAAMC,OACpBlB,OAELD,cAAcC,KAAM,QACpBgB,MAAMC,IAAI,IAEV/B,EAAEiC,KAAK,CACHC,IAAKC,EAAEC,IAAIC,QAAU,yCACrBC,OAAQ,OACRC,KAAM,CACFC,OAAQ1B,KACR2B,KAAMvC,YACNwC,QAASP,EAAEC,IAAIM,SAEnBC,QAAS,SAASC,QACVA,IAAIC,MAAO,CAEXhC,cADuB+B,IAAIC,MAAMC,QAAQ,MAAO,QAClB,YAE9BjC,cAAc,OAAS+B,IAAIG,OAAS,uBAAwB,QAGpEA,MAAO,SAASC,KACZnC,cAAc,iCAAkC,OAChDoC,QAAQF,MAAMC,kBA2BjBE,aACLlD,EAAE,sBAAsBmD,GAAG,SAAS,KAChCnD,EAAE,qBAAqBoD,YAAY,UACnCpD,EAAE,kBAAkBqD,WAGxBrD,EAAE,sBAAsBmD,GAAG,SAAS,KAChCnD,EAAE,qBAAqBsD,SAAS,aAGpCtD,EAAE,qBAAqBmD,GAAG,QAAStB,YAEnC7B,EAAE,kBAAkBmD,GAAG,YAAY,SAASI,GAC1B,UAAVA,EAAEC,MACFD,EAAEE,iBACF5B,iBAIR7B,EAAE,aAAamD,GAAG,SAAS,qBAxCNO,YACjBA,UAAYxD,YAAa,OAE7BA,YAAcwD,QACdT,QAAQU,gCAAyBzD,cAGjCF,EAAE,aAAa4D,YAAY,UAC3B5D,iCAA0BE,mBAAiBoD,SAAS,gBAG9CO,WAAa,CACfC,UAAW,eACXC,GAAI,eACJC,KAAM,kBACR9D,aACFF,EAAE,qBAAqBc,KAAK+C,YAE5BzD,cAwBI6D,CADajE,EAAEkE,MAAM3B,KAAK,kBAmB3B,CAAE4B,gBAbAC,SAASC,eAAe,kBACzBrE,EAAE,QAAQuB,OAAO,mDAAmDY,EAAEC,IAAIC,QAAQ,yCAGtFpC,UAAUqE,OAAO,2BAA4B,IACxCC,MAAKC,OACFxE,EAAE,QAAQuB,OAAOiD,MACjBtB,aACA9C,iBAEHqE,OAAMC,KAAOzB,QAAQF,MAAM,gCAAiC2B"}